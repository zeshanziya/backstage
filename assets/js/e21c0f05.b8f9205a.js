/*! For license information please see e21c0f05.b8f9205a.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[821287],{4721:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var r=n(824246),s=n(511151);const o={id:"custom-rules",title:"Defining custom permission rules",description:"How to define custom permission rules for existing resources"},i=void 0,a={id:"permissions/custom-rules",title:"Defining custom permission rules",description:"How to define custom permission rules for existing resources",source:"@site/../docs/permissions/custom-rules.md",sourceDirName:"permissions",slug:"/permissions/custom-rules",permalink:"/docs/permissions/custom-rules",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/permissions/custom-rules.md",tags:[],version:"current",frontMatter:{id:"custom-rules",title:"Defining custom permission rules",description:"How to define custom permission rules for existing resources"},sidebar:"docs",previous:{title:"Frontend Integration",permalink:"/docs/permissions/frontend-integration"},next:{title:"1. Tutorial setup",permalink:"/docs/permissions/plugin-authors/01-setup"}},c={},l=[{value:"Define a custom rule",id:"define-a-custom-rule",level:2},{value:"Provide the rule during plugin setup",id:"provide-the-rule-during-plugin-setup",level:2}];function u(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:["This documentation is written for ",(0,r.jsx)(t.a,{href:"/docs/backend-system/",children:"the new backend system"})," which is the default since Backstage ",(0,r.jsx)(t.a,{href:"/docs/releases/v1.24.0",children:"version 1.24"}),". If you are still on the old backend system, you may want to read ",(0,r.jsx)(t.a,{href:"/docs/permissions/custom-rules--old",children:"its own article"})," instead, and ",(0,r.jsx)(t.a,{href:"/docs/backend-system/building-backends/migrating",children:"consider migrating"}),"!"]})}),"\n",(0,r.jsxs)(t.p,{children:["For some use cases, you may want to define custom ",(0,r.jsx)(t.a,{href:"/docs/references/glossary#rule-permission-plugin",children:"rules"})," in addition to the ones provided by a plugin. In the ",(0,r.jsx)(t.a,{href:"/docs/permissions/writing-a-policy",children:"previous section"})," we used the ",(0,r.jsx)(t.code,{children:"isEntityOwner"})," rule to control access for catalog entities. Let's extend this policy with a custom rule that checks what ",(0,r.jsx)(t.a,{href:"https://backstage.io/docs/features/software-catalog/system-model#system",children:"system"})," an entity is part of."]}),"\n",(0,r.jsx)(t.h2,{id:"define-a-custom-rule",children:"Define a custom rule"}),"\n",(0,r.jsxs)(t.p,{children:["Plugins should export a rule factory that provides type-safety that ensures compatibility with the plugin's backend. The catalog plugin exports ",(0,r.jsx)(t.code,{children:"createCatalogPermissionRule"})," from ",(0,r.jsx)(t.code,{children:"@backstage/plugin-catalog-backend/alpha"})," for this purpose. Note: the ",(0,r.jsx)(t.code,{children:"/alpha"})," path segment is temporary until this API is marked as stable. For this example, we'll define the rule and create a condition in ",(0,r.jsx)(t.code,{children:"packages/backend/src/extensions/permissionsPolicyExtension.ts"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["We use ",(0,r.jsx)(t.code,{children:"zod"})," and ",(0,r.jsx)(t.code,{children:"@backstage/catalog-model"})," in our example below. To install them run:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",metastring:'title="from your Backstage root directory"',children:"yarn --cwd packages/backend add zod @backstage/catalog-model\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",metastring:'title="packages/backend/src/extensions/permissionsPolicyExtension.ts"',children:"...\n\nimport type { Entity } from '@backstage/catalog-model';\nimport { createCatalogPermissionRule } from '@backstage/plugin-catalog-backend/alpha';\nimport { createConditionFactory } from '@backstage/plugin-permission-node';\nimport { z } from 'zod';\n\nexport const isInSystemRule = createCatalogPermissionRule({\n  name: 'IS_IN_SYSTEM',\n  description: 'Checks if an entity is part of the system provided',\n  resourceType: 'catalog-entity',\n  paramsSchema: z.object({\n    systemRef: z\n      .string()\n      .describe('SystemRef to check the resource is part of'),\n  }),\n  apply: (resource: Entity, { systemRef }) => {\n    if (!resource.relations) {\n      return false;\n    }\n\n    return resource.relations\n      .filter(relation => relation.type === 'partOf')\n      .some(relation => relation.targetRef === systemRef);\n  },\n  toQuery: ({ systemRef }) => ({\n    key: 'relations.partOf',\n    values: [systemRef],\n  }),\n});\n\nconst isInSystem = createConditionFactory(isInSystemRule);\n\n...\n"})}),"\n",(0,r.jsxs)(t.p,{children:["For a more detailed explanation on defining rules, refer to the ",(0,r.jsx)(t.a,{href:"/docs/permissions/plugin-authors/03-adding-a-resource-permission-check#adding-support-for-conditional-decisions",children:"documentation for plugin authors"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["Still in the ",(0,r.jsx)(t.code,{children:"packages/backend/src/extensions/permissionsPolicyExtension.ts"})," file, let's use the condition we just created in our ",(0,r.jsx)(t.code,{children:"CustomPermissionPolicy"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",metastring:'title="packages/backend/src/extensions/permissionsPolicyExtension.ts"',children:"...\n/* highlight-remove-next-line */\nimport { createCatalogPermissionRule } from '@backstage/plugin-catalog-backend/alpha';\n/* highlight-add-next-line */\nimport { catalogConditions, createCatalogConditionalDecision, createCatalogPermissionRule } from '@backstage/plugin-catalog-backend/alpha';\n/* highlight-remove-next-line */\nimport { createConditionFactory } from '@backstage/plugin-permission-node';\n/* highlight-add-next-line */\nimport { PermissionPolicy, PolicyQuery, PolicyQueryUser, createConditionFactory } from '@backstage/plugin-permission-node';\n/* highlight-add-start */\nimport { AuthorizeResult, PolicyDecision, isResourcePermission } from '@backstage/plugin-permission-common';\n/* highlight-add-end */\n...\n\nexport const isInSystemRule = createCatalogPermissionRule({\n  name: 'IS_IN_SYSTEM',\n  description: 'Checks if an entity is part of the system provided',\n  resourceType: 'catalog-entity',\n  paramsSchema: z.object({\n    systemRef: z\n      .string()\n      .describe('SystemRef to check the resource is part of'),\n  }),\n  apply: (resource: Entity, { systemRef }) => {\n    if (!resource.relations) {\n      return false;\n    }\n\n    return resource.relations\n      .filter(relation => relation.type === 'partOf')\n      .some(relation => relation.targetRef === systemRef);\n  },\n  toQuery: ({ systemRef }) => ({\n    key: 'relations.partOf',\n    values: [systemRef],\n  }),\n});\n\nconst isInSystem = createConditionFactory(isInSystemRule);\n\nclass CustomPermissionPolicy implements PermissionPolicy {\n  async handle(\n    request: PolicyQuery,\n    user?: PolicyQueryUser,\n  ): Promise<PolicyDecision> {\n    if (isResourcePermission(request.permission, 'catalog-entity')) {\n      return createCatalogConditionalDecision(\n        request.permission,\n        /* highlight-remove-start */\n        catalogConditions.isEntityOwner({\n          claims: user?.info.ownershipEntityRefs ?? [],\n        }),\n        /* highlight-remove-end */\n        /* highlight-add-start */\n        {\n          anyOf: [\n            catalogConditions.isEntityOwner({\n              claims: user?.info.ownershipEntityRefs ?? [],\n            }),\n            isInSystem({ systemRef: 'interviewing' }),\n          ],\n        },\n        /* highlight-add-end */\n      );\n    }\n\n    return { result: AuthorizeResult.ALLOW };\n  }\n}\n\n...\n"})}),"\n",(0,r.jsx)(t.h2,{id:"provide-the-rule-during-plugin-setup",children:"Provide the rule during plugin setup"}),"\n",(0,r.jsxs)(t.p,{children:["Now that we have a custom rule defined and added to our policy, we need provide it to the catalog plugin. This step is important because the catalog plugin will use the rule's ",(0,r.jsx)(t.code,{children:"toQuery"})," and ",(0,r.jsx)(t.code,{children:"apply"})," methods while evaluating conditional authorize results. There's no guarantee that the catalog and permission backends are running on the same server, so we must explicitly link the rule to ensure that it's available at runtime."]}),"\n",(0,r.jsxs)(t.p,{children:["The api for providing custom rules may differ between plugins, but there should typically be an ",(0,r.jsx)(t.a,{href:"/docs/backend-system/architecture/extension-points",children:"extension point"})," that you can use in your created module to add your rule. For the catalog, this extension point is exposed via ",(0,r.jsx)(t.code,{children:"catalogPermissionExtensionPoint"}),". Here's the steps you'll need to take to add the ",(0,r.jsx)(t.code,{children:"isInSystemRule"})," we created above to the catalog:"]}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["We will be using the ",(0,r.jsx)(t.code,{children:"@backstage/plugin-catalog-node"})," package as it contains the extension point we need. Run this to add it:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",metastring:'title="from your Backstage root directory"',children:"yarn --cwd packages/backend add @backstage/plugin-catalog-node\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["Next create a ",(0,r.jsx)(t.code,{children:"catalogPermissionRules.ts"})," file in the ",(0,r.jsx)(t.code,{children:"packages/backend/src/extensions"})," folder."]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["Then add this as the contents of the new ",(0,r.jsx)(t.code,{children:"catalogPermissionRules.ts"})," file:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",metastring:'title="packages/backend/src/extensions/catalogPermissionRules.ts"',children:"import { createBackendModule } from '@backstage/backend-plugin-api';\nimport { catalogPermissionExtensionPoint } from '@backstage/plugin-catalog-node/alpha';\nimport { isInSystemRule } from './permissionPolicyExtension';\n\nexport default createBackendModule({\n  pluginId: 'catalog',\n  moduleId: 'permission-rules',\n  register(reg) {\n    reg.registerInit({\n      deps: { catalog: catalogPermissionExtensionPoint },\n      async init({ catalog }) {\n        catalog.addPermissionRules(isInSystemRule);\n      },\n    });\n  },\n});\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:"Next we need to add this to the backend by adding the following line:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"// catalog plugin\nbackend.add(import('@backstage/plugin-catalog-backend/alpha'));\nbackend.add(\n  import('@backstage/plugin-catalog-backend-module-scaffolder-entity-model'),\n);\n/* highlight-add-next-line */\nbackend.add(import('./extensions/catalogPermissionRules'));\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["Now when you run you Backstage instance - ",(0,r.jsx)(t.code,{children:"yarn dev"})," - the rule will be added to the catalog plugin."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"The updated policy will allow catalog entity resource permissions if any of the following are true:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"User owns the target entity"}),"\n",(0,r.jsx)(t.li,{children:"Target entity is part of the 'interviewing' system"}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},371426:(e,t,n)=>{var r=n(827378),s=Symbol.for("react.element"),o=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,a=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,n){var r,o={},l=null,u=null;for(r in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(u=t.ref),t)i.call(t,r)&&!c.hasOwnProperty(r)&&(o[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===o[r]&&(o[r]=t[r]);return{$$typeof:s,type:e,key:l,ref:u,props:o,_owner:a.current}}t.Fragment=o,t.jsx=l,t.jsxs=l},541535:(e,t)=>{var n=Symbol.for("react.element"),r=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),c=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),f=Symbol.iterator;var h={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,y={};function g(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||h}function x(){}function b(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||h}g.prototype.isReactComponent={},g.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},g.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},x.prototype=g.prototype;var k=b.prototype=new x;k.constructor=b,m(k,g.prototype),k.isPureReactComponent=!0;var j=Array.isArray,v=Object.prototype.hasOwnProperty,w={current:null},_={key:!0,ref:!0,__self:!0,__source:!0};function R(e,t,r){var s,o={},i=null,a=null;if(null!=t)for(s in void 0!==t.ref&&(a=t.ref),void 0!==t.key&&(i=""+t.key),t)v.call(t,s)&&!_.hasOwnProperty(s)&&(o[s]=t[s]);var c=arguments.length-2;if(1===c)o.children=r;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];o.children=l}if(e&&e.defaultProps)for(s in c=e.defaultProps)void 0===o[s]&&(o[s]=c[s]);return{$$typeof:n,type:e,key:i,ref:a,props:o,_owner:w.current}}function P(e){return"object"==typeof e&&null!==e&&e.$$typeof===n}var S=/\/+/g;function E(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function C(e,t,s,o,i){var a=typeof e;"undefined"!==a&&"boolean"!==a||(e=null);var c=!1;if(null===e)c=!0;else switch(a){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case n:case r:c=!0}}if(c)return i=i(c=e),e=""===o?"."+E(c,0):o,j(i)?(s="",null!=e&&(s=e.replace(S,"$&/")+"/"),C(i,t,s,"",(function(e){return e}))):null!=i&&(P(i)&&(i=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(i,s+(!i.key||c&&c.key===i.key?"":(""+i.key).replace(S,"$&/")+"/")+e)),t.push(i)),1;if(c=0,o=""===o?".":o+":",j(e))for(var l=0;l<e.length;l++){var u=o+E(a=e[l],l);c+=C(a,t,s,u,i)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),l=0;!(a=e.next()).done;)c+=C(a=a.value,t,s,u=o+E(a,l++),i);else if("object"===a)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return c}function I(e,t,n){if(null==e)return e;var r=[],s=0;return C(e,r,"","",(function(e){return t.call(n,e,s++)})),r}function O(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var T={current:null},$={transition:null},N={ReactCurrentDispatcher:T,ReactCurrentBatchConfig:$,ReactCurrentOwner:w};function D(){throw Error("act(...) is not supported in production builds of React.")}t.Children={map:I,forEach:function(e,t,n){I(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return I(e,(function(){t++})),t},toArray:function(e){return I(e,(function(e){return e}))||[]},only:function(e){if(!P(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=g,t.Fragment=s,t.Profiler=i,t.PureComponent=b,t.StrictMode=o,t.Suspense=u,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=N,t.act=D,t.cloneElement=function(e,t,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var s=m({},e.props),o=e.key,i=e.ref,a=e._owner;if(null!=t){if(void 0!==t.ref&&(i=t.ref,a=w.current),void 0!==t.key&&(o=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(l in t)v.call(t,l)&&!_.hasOwnProperty(l)&&(s[l]=void 0===t[l]&&void 0!==c?c[l]:t[l])}var l=arguments.length-2;if(1===l)s.children=r;else if(1<l){c=Array(l);for(var u=0;u<l;u++)c[u]=arguments[u+2];s.children=c}return{$$typeof:n,type:e.type,key:o,ref:i,props:s,_owner:a}},t.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},t.createElement=R,t.createFactory=function(e){var t=R.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:l,render:e}},t.isValidElement=P,t.lazy=function(e){return{$$typeof:p,_payload:{_status:-1,_result:e},_init:O}},t.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=$.transition;$.transition={};try{e()}finally{$.transition=t}},t.unstable_act=D,t.useCallback=function(e,t){return T.current.useCallback(e,t)},t.useContext=function(e){return T.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return T.current.useDeferredValue(e)},t.useEffect=function(e,t){return T.current.useEffect(e,t)},t.useId=function(){return T.current.useId()},t.useImperativeHandle=function(e,t,n){return T.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return T.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return T.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return T.current.useMemo(e,t)},t.useReducer=function(e,t,n){return T.current.useReducer(e,t,n)},t.useRef=function(e){return T.current.useRef(e)},t.useState=function(e){return T.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return T.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return T.current.useTransition()},t.version="18.3.1"},827378:(e,t,n)=>{e.exports=n(541535)},824246:(e,t,n)=>{e.exports=n(371426)},511151:(e,t,n)=>{n.d(t,{Z:()=>a,a:()=>i});var r=n(667294);const s={},o=r.createContext(s);function i(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);