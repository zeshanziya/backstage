/*! For license information please see f1bed9bd.e3a8da99.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[107644],{104391:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var r=t(824246),a=t(511151);const o={id:"configuring-plugin-databases",title:"Configuring Plugin Databases",description:"Guide on how to configure Backstage databases."},s=void 0,i={id:"tutorials/configuring-plugin-databases",title:"Configuring Plugin Databases",description:"Guide on how to configure Backstage databases.",source:"@site/../docs/tutorials/configuring-plugin-databases.md",sourceDirName:"tutorials",slug:"/tutorials/configuring-plugin-databases",permalink:"/docs/tutorials/configuring-plugin-databases",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/tutorials/configuring-plugin-databases.md",tags:[],version:"current",frontMatter:{id:"configuring-plugin-databases",title:"Configuring Plugin Databases",description:"Guide on how to configure Backstage databases."},sidebar:"docs",previous:{title:"Migrating away from @backstage/core",permalink:"/docs/tutorials/migrating-away-from-core"},next:{title:"Switching Backstage from SQLite to PostgreSQL",permalink:"/docs/tutorials/switching-sqlite-postgres"}},c={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Dependencies",id:"dependencies",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Minimal In-Memory Configuration",id:"minimal-in-memory-configuration",level:3},{value:"PostgreSQL",id:"postgresql",level:3},{value:"Custom Database Name Prefix",id:"custom-database-name-prefix",level:3},{value:"Connection Configuration Per Plugin",id:"connection-configuration-per-plugin",level:3},{value:"PostgreSQL and SQLite 3",id:"postgresql-and-sqlite-3",level:3},{value:"Check Your Databases",id:"check-your-databases",level:2},{value:"Privileges",id:"privileges",level:3}];function u(e){const n=Object.assign({p:"p",code:"code",a:"a",h2:"h2",h3:"h3",pre:"pre",strong:"strong"},(0,a.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"This guide covers a variety of production persistence use cases which are\nsupported out of the box by Backstage. The database manager allows the developer\nto set the client and database connection details on a per plugin basis in\naddition to the base client and connection configuration. This means that you\ncan use a SQLite 3 in-memory database for a specific plugin whilst using\nPostgreSQL for everything else and so on."}),"\n",(0,r.jsxs)(n.p,{children:["By default, Backstage uses automatically created databases for each plugin whose\nnames follow the ",(0,r.jsx)(n.code,{children:"backstage_plugin_<pluginId>"})," pattern, e.g.\n",(0,r.jsx)(n.code,{children:"backstage_plugin_auth"}),". You can configure a different database name prefix for\nuse cases where you have multiple deployments running on a shared database\ninstance or cluster."]}),"\n",(0,r.jsxs)(n.p,{children:["With infrastructure defined as code or data (Terraform, AWS CloudFormation,\netc.), you may have database credentials which lack permissions to create new\ndatabases or you do not have control over the database names. In these\ninstances, you can set the database connection configuration on a\n",(0,r.jsx)(n.a,{href:"#connection-configuration-per-plugin",children:"per plugin basis"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Backstage supports all of these use cases with the ",(0,r.jsx)(n.code,{children:"DatabaseManager"})," provided by\n",(0,r.jsx)(n.code,{children:"@backstage/backend-common"}),". We will now cover how to use and configure\nBackstage's databases."]}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsx)(n.h3,{id:"dependencies",children:"Dependencies"}),"\n",(0,r.jsxs)(n.p,{children:["Please ensure the appropriate database drivers are installed in your ",(0,r.jsx)(n.code,{children:"backend"}),"\npackage. If you intend to use both PostgreSQL and SQLite, you can install\nboth of them."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# From your Backstage root directory\n# install pg if you need PostgreSQL\nyarn --cwd packages/backend add pg\n\n# install SQLite 3 if you intend to set it as the client\nyarn --cwd packages/backend add better-sqlite3\n"})}),"\n",(0,r.jsx)(n.p,{children:"From an operational perspective, you only need to install drivers for clients\nthat are actively used."}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["You should set the base database client and connection information in your\n",(0,r.jsx)(n.code,{children:"app-config.yaml"})," (or equivalent) file. The base client and configuration is\nused as the default which is extended for each plugin with the same or unset\nclient type. If a client type is specified for a specific plugin which does not\nmatch the base client, the configuration set for the plugin will be used as is\nwithout extending the base configuration."]}),"\n",(0,r.jsxs)(n.p,{children:["Client type and configuration for plugins need to be defined under\n",(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"backend.database.plugin.<pluginId>"})}),". As an example, ",(0,r.jsx)(n.code,{children:"catalog"})," is the\n",(0,r.jsx)(n.code,{children:"pluginId"})," for the catalog plugin and any configuration defined under that block\nis specific to that plugin. We will now explore more detailed example\nconfigurations below."]}),"\n",(0,r.jsx)(n.h3,{id:"minimal-in-memory-configuration",children:"Minimal In-Memory Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["In the example below, we are using ",(0,r.jsx)(n.code,{children:"better-sqlite3"})," in-memory databases for all\nplugins. You may want to use this configuration for testing or other non-durable\nuse cases."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"backend:\n  database:\n    client: better-sqlite3\n    connection: ':memory:'\n"})}),"\n",(0,r.jsx)(n.h3,{id:"postgresql",children:"PostgreSQL"}),"\n",(0,r.jsxs)(n.p,{children:["The example below uses PostgreSQL (",(0,r.jsx)(n.code,{children:"pg"}),") as the database client for all plugins.\nThe ",(0,r.jsx)(n.code,{children:"auth"})," plugin uses a user defined database name instead of the automatically\ngenerated one which would have been ",(0,r.jsx)(n.code,{children:"backstage_plugin_auth"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"backend:\n  database:\n    client: pg\n    connection:\n      host: some.example-pg-instance.tld\n      user: postgres\n      password: password\n      port: 5432\n    plugin:\n      auth:\n        connection:\n          database: pg_auth_set_by_user\n"})}),"\n",(0,r.jsx)(n.h3,{id:"custom-database-name-prefix",children:"Custom Database Name Prefix"}),"\n",(0,r.jsxs)(n.p,{children:["The configuration below uses ",(0,r.jsx)(n.code,{children:"example_prefix_"})," as the database name prefix\ninstead of ",(0,r.jsx)(n.code,{children:"backstage_plugin_"}),". Plugins such as ",(0,r.jsx)(n.code,{children:"auth"})," and ",(0,r.jsx)(n.code,{children:"catalog"})," will use\ndatabases named ",(0,r.jsx)(n.code,{children:"example_prefix_auth"})," and ",(0,r.jsx)(n.code,{children:"example_prefix_catalog"})," respectively."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"backend:\n  database:\n    client: pg\n    connection:\n      host: some.example-pg-instance.tld\n      user: postgres\n      password: password\n      port: 5432\n    prefix: 'example_prefix_'\n"})}),"\n",(0,r.jsx)(n.h3,{id:"connection-configuration-per-plugin",children:"Connection Configuration Per Plugin"}),"\n",(0,r.jsxs)(n.p,{children:["Both ",(0,r.jsx)(n.code,{children:"auth"})," and ",(0,r.jsx)(n.code,{children:"catalog"})," use connection configuration with different\ncredentials and database names. This type of configuration can be useful for\nenvironments with infrastructure as code or data which may provide randomly\ngenerated credentials and/or database names."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"backend:\n  database:\n    client: pg\n    connection: 'postgresql://some.example-pg-instance.tld:5432'\n    plugin:\n      auth:\n        connection: 'postgresql://fort:knox@some.example-pg-instance.tld:5432/unwitting_fox_jumps'\n      catalog:\n        connection: 'postgresql://bank:reserve@some.example-pg-instance.tld:5432/shuffle_ransack_playback'\n"})}),"\n",(0,r.jsx)(n.h3,{id:"postgresql-and-sqlite-3",children:"PostgreSQL and SQLite 3"}),"\n",(0,r.jsxs)(n.p,{children:["The example below uses PostgreSQL (",(0,r.jsx)(n.code,{children:"pg"}),") as the database client for all plugins\nexcept the ",(0,r.jsx)(n.code,{children:"auth"})," plugin which uses ",(0,r.jsx)(n.code,{children:"better-sqlite3"}),". As the ",(0,r.jsx)(n.code,{children:"auth"})," plugin's client\ntype is different from the base client type, the connection configuration for\n",(0,r.jsx)(n.code,{children:"auth"})," is used verbatim without extending the base configuration for PostgreSQL."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"backend:\n  database:\n    client: pg\n    connection: 'postgresql://foo:bar@some.example-pg-instance.tld:5432'\n    plugin:\n      auth:\n        client: better-sqlite3\n        connection: ':memory:'\n"})}),"\n",(0,r.jsx)(n.h2,{id:"check-your-databases",children:"Check Your Databases"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"DatabaseManager"})," will attempt to create the databases if they do not exist.\nIf you have set credentials per plugin because the credentials in the base\nconfiguration do not have permissions to create databases, you must ensure they\nexist before starting the service. The service will not be able to create them,\nit can only use them."]}),"\n",(0,r.jsx)(n.h3,{id:"privileges",children:"Privileges"}),"\n",(0,r.jsx)(n.p,{children:"As Backstage attempts to check if the database exists, you may need to grant\nprivileges to list or show databases for a given user. For PostgreSQL, you would\ngrant the following:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-postgres",children:"GRANT SELECT ON pg_database TO some_user;\n"})}),"\n",(0,r.jsx)(n.p,{children:"MySQL:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-mysql",children:"GRANT SHOW DATABASES ON *.* TO some_user;\n"})}),"\n",(0,r.jsx)(n.p,{children:"The mechanisms in this guide should help you tackle different database\ndeployment situations. Good luck!"})]})}const d=function(e={}){const{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,r.jsx)(n,Object.assign({},e,{children:(0,r.jsx)(u,e)})):u(e)}},371426:(e,n,t)=>{var r=t(827378),a=Symbol.for("react.element"),o=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,i=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,n,t){var r,o={},l=null,u=null;for(r in void 0!==t&&(l=""+t),void 0!==n.key&&(l=""+n.key),void 0!==n.ref&&(u=n.ref),n)s.call(n,r)&&!c.hasOwnProperty(r)&&(o[r]=n[r]);if(e&&e.defaultProps)for(r in n=e.defaultProps)void 0===o[r]&&(o[r]=n[r]);return{$$typeof:a,type:e,key:l,ref:u,props:o,_owner:i.current}}n.Fragment=o,n.jsx=l,n.jsxs=l},541535:(e,n)=>{var t=Symbol.for("react.element"),r=Symbol.for("react.portal"),a=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),i=Symbol.for("react.provider"),c=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),f=Symbol.for("react.lazy"),p=Symbol.iterator;var h={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},g=Object.assign,m={};function y(e,n,t){this.props=e,this.context=n,this.refs=m,this.updater=t||h}function b(){}function x(e,n,t){this.props=e,this.context=n,this.refs=m,this.updater=t||h}y.prototype.isReactComponent={},y.prototype.setState=function(e,n){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,n,"setState")},y.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},b.prototype=y.prototype;var v=x.prototype=new b;v.constructor=x,g(v,y.prototype),v.isPureReactComponent=!0;var j=Array.isArray,_=Object.prototype.hasOwnProperty,w={current:null},k={key:!0,ref:!0,__self:!0,__source:!0};function S(e,n,r){var a,o={},s=null,i=null;if(null!=n)for(a in void 0!==n.ref&&(i=n.ref),void 0!==n.key&&(s=""+n.key),n)_.call(n,a)&&!k.hasOwnProperty(a)&&(o[a]=n[a]);var c=arguments.length-2;if(1===c)o.children=r;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];o.children=l}if(e&&e.defaultProps)for(a in c=e.defaultProps)void 0===o[a]&&(o[a]=c[a]);return{$$typeof:t,type:e,key:s,ref:i,props:o,_owner:w.current}}function P(e){return"object"==typeof e&&null!==e&&e.$$typeof===t}var C=/\/+/g;function E(e,n){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var n={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return n[e]}))}(""+e.key):n.toString(36)}function T(e,n,a,o,s){var i=typeof e;"undefined"!==i&&"boolean"!==i||(e=null);var c=!1;if(null===e)c=!0;else switch(i){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case t:case r:c=!0}}if(c)return s=s(c=e),e=""===o?"."+E(c,0):o,j(s)?(a="",null!=e&&(a=e.replace(C,"$&/")+"/"),T(s,n,a,"",(function(e){return e}))):null!=s&&(P(s)&&(s=function(e,n){return{$$typeof:t,type:e.type,key:n,ref:e.ref,props:e.props,_owner:e._owner}}(s,a+(!s.key||c&&c.key===s.key?"":(""+s.key).replace(C,"$&/")+"/")+e)),n.push(s)),1;if(c=0,o=""===o?".":o+":",j(e))for(var l=0;l<e.length;l++){var u=o+E(i=e[l],l);c+=T(i,n,a,u,s)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=p&&e[p]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),l=0;!(i=e.next()).done;)c+=T(i=i.value,n,a,u=o+E(i,l++),s);else if("object"===i)throw n=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===n?"object with keys {"+Object.keys(e).join(", ")+"}":n)+"). If you meant to render a collection of children, use an array instead.");return c}function O(e,n,t){if(null==e)return e;var r=[],a=0;return T(e,r,"","",(function(e){return n.call(t,e,a++)})),r}function R(e){if(-1===e._status){var n=e._result;(n=n()).then((function(n){0!==e._status&&-1!==e._status||(e._status=1,e._result=n)}),(function(n){0!==e._status&&-1!==e._status||(e._status=2,e._result=n)})),-1===e._status&&(e._status=0,e._result=n)}if(1===e._status)return e._result.default;throw e._result}var L={current:null},q={transition:null},$={ReactCurrentDispatcher:L,ReactCurrentBatchConfig:q,ReactCurrentOwner:w};n.Children={map:O,forEach:function(e,n,t){O(e,(function(){n.apply(this,arguments)}),t)},count:function(e){var n=0;return O(e,(function(){n++})),n},toArray:function(e){return O(e,(function(e){return e}))||[]},only:function(e){if(!P(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},n.Component=y,n.Fragment=a,n.Profiler=s,n.PureComponent=x,n.StrictMode=o,n.Suspense=u,n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=$,n.cloneElement=function(e,n,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var a=g({},e.props),o=e.key,s=e.ref,i=e._owner;if(null!=n){if(void 0!==n.ref&&(s=n.ref,i=w.current),void 0!==n.key&&(o=""+n.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(l in n)_.call(n,l)&&!k.hasOwnProperty(l)&&(a[l]=void 0===n[l]&&void 0!==c?c[l]:n[l])}var l=arguments.length-2;if(1===l)a.children=r;else if(1<l){c=Array(l);for(var u=0;u<l;u++)c[u]=arguments[u+2];a.children=c}return{$$typeof:t,type:e.type,key:o,ref:s,props:a,_owner:i}},n.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:i,_context:e},e.Consumer=e},n.createElement=S,n.createFactory=function(e){var n=S.bind(null,e);return n.type=e,n},n.createRef=function(){return{current:null}},n.forwardRef=function(e){return{$$typeof:l,render:e}},n.isValidElement=P,n.lazy=function(e){return{$$typeof:f,_payload:{_status:-1,_result:e},_init:R}},n.memo=function(e,n){return{$$typeof:d,type:e,compare:void 0===n?null:n}},n.startTransition=function(e){var n=q.transition;q.transition={};try{e()}finally{q.transition=n}},n.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},n.useCallback=function(e,n){return L.current.useCallback(e,n)},n.useContext=function(e){return L.current.useContext(e)},n.useDebugValue=function(){},n.useDeferredValue=function(e){return L.current.useDeferredValue(e)},n.useEffect=function(e,n){return L.current.useEffect(e,n)},n.useId=function(){return L.current.useId()},n.useImperativeHandle=function(e,n,t){return L.current.useImperativeHandle(e,n,t)},n.useInsertionEffect=function(e,n){return L.current.useInsertionEffect(e,n)},n.useLayoutEffect=function(e,n){return L.current.useLayoutEffect(e,n)},n.useMemo=function(e,n){return L.current.useMemo(e,n)},n.useReducer=function(e,n,t){return L.current.useReducer(e,n,t)},n.useRef=function(e){return L.current.useRef(e)},n.useState=function(e){return L.current.useState(e)},n.useSyncExternalStore=function(e,n,t){return L.current.useSyncExternalStore(e,n,t)},n.useTransition=function(){return L.current.useTransition()},n.version="18.2.0"},827378:(e,n,t)=>{e.exports=t(541535)},824246:(e,n,t)=>{e.exports=t(371426)},511151:(e,n,t)=>{t.d(n,{Zo:()=>i,ah:()=>o});var r=t(667294);const a=r.createContext({});function o(e){const n=r.useContext(a);return r.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}const s={};function i({components:e,children:n,disableParentContext:t}){let i;return i=t?"function"==typeof e?e({}):e||s:o(e),r.createElement(a.Provider,{value:i},n)}}}]);