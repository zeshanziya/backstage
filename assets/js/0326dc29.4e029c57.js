/*! For license information please see 0326dc29.4e029c57.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[662468],{828462:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var r=n(824246),o=n(511151);const i={id:"gcp-iap-auth",title:"Google Identity-Aware Proxy Provider",sidebar_label:"Google IAP",description:"Adding Google Identity-Aware Proxy as an authentication provider in Backstage"},a=void 0,s={id:"auth/google/gcp-iap-auth",title:"Google Identity-Aware Proxy Provider",description:"Adding Google Identity-Aware Proxy as an authentication provider in Backstage",source:"@site/../docs/auth/google/gcp-iap-auth.md",sourceDirName:"auth/google",slug:"/auth/google/gcp-iap-auth",permalink:"/docs/auth/google/gcp-iap-auth",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/auth/google/gcp-iap-auth.md",tags:[],version:"current",frontMatter:{id:"gcp-iap-auth",title:"Google Identity-Aware Proxy Provider",sidebar_label:"Google IAP",description:"Adding Google Identity-Aware Proxy as an authentication provider in Backstage"},sidebar:"docs",previous:{title:"Google",permalink:"/docs/auth/google/provider"},next:{title:"Guest",permalink:"/docs/auth/guest/provider"}},c={},l=[{value:"Configuration",id:"configuration",level:2},{value:"Resolvers",id:"resolvers",level:3},{value:"Backend Changes",id:"backend-changes",level:2},{value:"Legacy Backend Changes",id:"legacy-backend-changes",level:3},{value:"Frontend Changes",id:"frontend-changes",level:2}];function u(e){const t={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["Backstage allows offloading the responsibility of authenticating users to the\nGoogle HTTPS Load Balancer & ",(0,r.jsx)(t.a,{href:"https://cloud.google.com/iap",children:"IAP"}),", leveraging the\nauthentication support on the latter."]}),"\n",(0,r.jsx)(t.p,{children:"This tutorial shows how to use authentication on an IAP sitting in front of\nBackstage."}),"\n",(0,r.jsx)(t.p,{children:"It is assumed an IAP is already serving traffic in front of a Backstage instance\nconfigured to serve the frontend app from the backend."}),"\n",(0,r.jsx)(t.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(t.p,{children:["Let's start by adding the following ",(0,r.jsx)(t.code,{children:"auth"})," configuration in your\n",(0,r.jsx)(t.code,{children:"app-config.yaml"})," or ",(0,r.jsx)(t.code,{children:"app-config.production.yaml"})," or similar:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"auth:\n  providers:\n    gcp-iap:\n      audience: '/projects/<project number>/global/backendServices/<backend service id>'\n      jwtHeader: x-custom-header # Optional: Only if you are using a custom header for the IAP JWT\n      signIn:\n        resolvers:\n          # typically you would pick one of these\n          - resolver: emailMatchingUserEntityProfileEmail\n          - resolver: emailLocalPartMatchingUserEntityName\n          - resolver: emailMatchingUserEntityAnnotation\n"})}),"\n",(0,r.jsxs)(t.p,{children:["The full ",(0,r.jsx)(t.code,{children:"audience"})," value can be obtained by visiting your ",(0,r.jsx)(t.a,{href:"https://console.cloud.google.com/security/iap",children:"Identity-Aware Proxy Google Cloud console"}),', selecting your project, finding your Backend Service to proxy, clicking the 3 vertical dots then "Get JWT Audience Code", and copying from the resulting popup, which will look similar to the following:']}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Identity-Aware Proxy JWT Audience Code popup",src:n(87802).Z+"",width:"866",height:"501"})}),"\n",(0,r.jsx)(t.p,{children:"This config section must be in place for the provider to load at all. Now let's\nadd the provider itself."}),"\n",(0,r.jsx)(t.h3,{id:"resolvers",children:"Resolvers"}),"\n",(0,r.jsx)(t.p,{children:"This provider includes several resolvers out of the box that you can use:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"emailMatchingUserEntityProfileEmail"}),": Matches the email address from the auth provider with the User entity that has a matching ",(0,r.jsx)(t.code,{children:"spec.profile.email"}),". If no match is found it will throw a ",(0,r.jsx)(t.code,{children:"NotFoundError"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"emailLocalPartMatchingUserEntityName"}),": Matches the ",(0,r.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Email_address#Local-part",children:"local part"})," of the email address from the auth provider with the User entity that has a matching ",(0,r.jsx)(t.code,{children:"name"}),". If no match is found it will throw a ",(0,r.jsx)(t.code,{children:"NotFoundError"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"emailMatchingUserEntityAnnotation"}),": Matches the email address from the auth provider with the User entity where the value of the ",(0,r.jsx)(t.code,{children:"google.com/email"})," annotation matches. If no match is found it will throw a ",(0,r.jsx)(t.code,{children:"NotFoundError"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsxs)(t.p,{children:["Note: The resolvers will be tried in order, but will only be skipped if they throw a ",(0,r.jsx)(t.code,{children:"NotFoundError"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["If these resolvers do not fit your needs you can build a custom resolver, this is covered in the ",(0,r.jsx)(t.a,{href:"/docs/auth/identity-resolver#building-custom-resolvers",children:"Building Custom Resolvers"})," section of the Sign-in Identities and Resolvers documentation."]}),"\n",(0,r.jsx)(t.h2,{id:"backend-changes",children:"Backend Changes"}),"\n",(0,r.jsx)(t.p,{children:"There is a module for this provider that you will need to add to your backend."}),"\n",(0,r.jsx)(t.p,{children:"First you'll want to run this command to add the module:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:" yarn --cwd packages/backend add @backstage/plugin-auth-backend-module-gcp-iap-provider\n"})}),"\n",(0,r.jsx)(t.p,{children:"Then you will need to add this to your backend:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"const backend = createBackend();\n\nbackend.add(import('@backstage/plugin-auth-backend'));\n/* highlight-add-start */\nbackend.add(import('@backstage/plugin-auth-backend-module-gcp-iap-provider'));\n/* highlight-add-end */\n"})}),"\n",(0,r.jsx)(t.h3,{id:"legacy-backend-changes",children:"Legacy Backend Changes"}),"\n",(0,r.jsx)(t.p,{children:"If you are still using the legacy backend you will need to make the changes outlined here."}),"\n",(0,r.jsx)(t.p,{children:"This provider is not enabled by default in the auth backend code, because besides the config section above, it also needs to be given one or more callbacks in actual code as well as described below."}),"\n",(0,r.jsxs)(t.p,{children:["Add a ",(0,r.jsx)(t.code,{children:"providerFactories"})," entry to the router in\n",(0,r.jsx)(t.code,{children:"packages/backend/src/plugins/auth.ts"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",metastring:'title="packages/backend/src/plugins/auth.ts"',children:"import { providers } from '@backstage/plugin-auth-backend';\nimport { stringifyEntityRef } from '@backstage/catalog-model';\n\nexport default async function createPlugin(\n  env: PluginEnvironment,\n): Promise<Router> {\n  return await createRouter({\n    logger: env.logger,\n    config: env.config,\n    database: env.database,\n    discovery: env.discovery,\n    providerFactories: {\n      'gcp-iap': providers.gcpIap.create({\n        // Replace the auth handler if you want to customize the returned user\n        // profile info (can be left out; the default implementation is shown\n        // below which only returns the email). You may want to amend this code\n        // with something that loads additional user profile data out of e.g.\n        // GSuite or LDAP or similar.\n        async authHandler({ iapToken }) {\n          return { profile: { email: iapToken.email } };\n        },\n        signIn: {\n          // You need to supply an identity resolver, that takes the profile\n          // and the IAP token and produces the Backstage token with the\n          // relevant user info.\n          async resolver({ profile, result: { iapToken } }, ctx) {\n            // Somehow compute the Backstage token claims. Just some sample code\n            // shown here, but you may want to query your LDAP server, or\n            // GSuite or similar, based on the IAP token sub/email claims\n            const id = iapToken.email.split('@')[0];\n            const sub = stringifyEntityRef({ kind: 'User', name: id });\n            const ent = [\n              sub,\n              stringifyEntityRef({ kind: 'Group', name: 'team-name' }),\n            ];\n            return ctx.issueToken({ claims: { sub, ent } });\n          },\n        },\n      }),\n    },\n  });\n}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Now the backend is ready to serve auth requests on the\n",(0,r.jsx)(t.code,{children:"/api/auth/gcp-iap/refresh"})," endpoint. All that's left is to update the frontend\nsign-in mechanism to poll that endpoint through the IAP, on the user's behalf."]}),"\n",(0,r.jsx)(t.h2,{id:"frontend-changes",children:"Frontend Changes"}),"\n",(0,r.jsxs)(t.p,{children:["It is recommended to use the ",(0,r.jsx)(t.code,{children:"ProxiedSignInPage"})," for this provider, which is\ninstalled in ",(0,r.jsx)(t.code,{children:"packages/app/src/App.tsx"})," like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",metastring:'title="packages/app/src/App.tsx"',children:"/* highlight-add-next-line */\nimport { ProxiedSignInPage } from '@backstage/core-components';\n\nconst app = createApp({\n  /* highlight-add-start */\n  components: {\n    SignInPage: props => <ProxiedSignInPage {...props} provider=\"gcp-iap\" />,\n  },\n  /* highlight-add-end */\n  // ..\n});\n"})}),"\n",(0,r.jsxs)(t.p,{children:["See the ",(0,r.jsx)(t.a,{href:"/docs/auth/#sign-in-with-proxy-providers",children:"Sign-In with Proxy Providers"})," section for more information."]})]})}function d(e={}){const{wrapper:t}={...(0,o.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},87802:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/gcp-iap-jwt-audience-code-popup-af9b9676c8c8cc772a0cbeae159b0d91.png"},371426:(e,t,n)=>{var r=n(827378),o=Symbol.for("react.element"),i=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,s=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,n){var r,i={},l=null,u=null;for(r in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(u=t.ref),t)a.call(t,r)&&!c.hasOwnProperty(r)&&(i[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===i[r]&&(i[r]=t[r]);return{$$typeof:o,type:e,key:l,ref:u,props:i,_owner:s.current}}t.Fragment=i,t.jsx=l,t.jsxs=l},541535:(e,t)=>{var n=Symbol.for("react.element"),r=Symbol.for("react.portal"),o=Symbol.for("react.fragment"),i=Symbol.for("react.strict_mode"),a=Symbol.for("react.profiler"),s=Symbol.for("react.provider"),c=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),h=Symbol.for("react.lazy"),p=Symbol.iterator;var f={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},g=Object.assign,y={};function m(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||f}function v(){}function b(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||f}m.prototype.isReactComponent={},m.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},m.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},v.prototype=m.prototype;var x=b.prototype=new v;x.constructor=b,g(x,m.prototype),x.isPureReactComponent=!0;var k=Array.isArray,j=Object.prototype.hasOwnProperty,w={current:null},_={key:!0,ref:!0,__self:!0,__source:!0};function P(e,t,r){var o,i={},a=null,s=null;if(null!=t)for(o in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(a=""+t.key),t)j.call(t,o)&&!_.hasOwnProperty(o)&&(i[o]=t[o]);var c=arguments.length-2;if(1===c)i.children=r;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];i.children=l}if(e&&e.defaultProps)for(o in c=e.defaultProps)void 0===i[o]&&(i[o]=c[o]);return{$$typeof:n,type:e,key:a,ref:s,props:i,_owner:w.current}}function S(e){return"object"==typeof e&&null!==e&&e.$$typeof===n}var E=/\/+/g;function I(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function A(e,t,o,i,a){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var c=!1;if(null===e)c=!0;else switch(s){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case n:case r:c=!0}}if(c)return a=a(c=e),e=""===i?"."+I(c,0):i,k(a)?(o="",null!=e&&(o=e.replace(E,"$&/")+"/"),A(a,t,o,"",(function(e){return e}))):null!=a&&(S(a)&&(a=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(a,o+(!a.key||c&&c.key===a.key?"":(""+a.key).replace(E,"$&/")+"/")+e)),t.push(a)),1;if(c=0,i=""===i?".":i+":",k(e))for(var l=0;l<e.length;l++){var u=i+I(s=e[l],l);c+=A(s,t,o,u,a)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=p&&e[p]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),l=0;!(s=e.next()).done;)c+=A(s=s.value,t,o,u=i+I(s,l++),a);else if("object"===s)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return c}function C(e,t,n){if(null==e)return e;var r=[],o=0;return A(e,r,"","",(function(e){return t.call(n,e,o++)})),r}function R(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var T={current:null},$={transition:null},O={ReactCurrentDispatcher:T,ReactCurrentBatchConfig:$,ReactCurrentOwner:w};t.Children={map:C,forEach:function(e,t,n){C(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return C(e,(function(){t++})),t},toArray:function(e){return C(e,(function(e){return e}))||[]},only:function(e){if(!S(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=m,t.Fragment=o,t.Profiler=a,t.PureComponent=b,t.StrictMode=i,t.Suspense=u,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=O,t.cloneElement=function(e,t,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var o=g({},e.props),i=e.key,a=e.ref,s=e._owner;if(null!=t){if(void 0!==t.ref&&(a=t.ref,s=w.current),void 0!==t.key&&(i=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(l in t)j.call(t,l)&&!_.hasOwnProperty(l)&&(o[l]=void 0===t[l]&&void 0!==c?c[l]:t[l])}var l=arguments.length-2;if(1===l)o.children=r;else if(1<l){c=Array(l);for(var u=0;u<l;u++)c[u]=arguments[u+2];o.children=c}return{$$typeof:n,type:e.type,key:i,ref:a,props:o,_owner:s}},t.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:s,_context:e},e.Consumer=e},t.createElement=P,t.createFactory=function(e){var t=P.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:l,render:e}},t.isValidElement=S,t.lazy=function(e){return{$$typeof:h,_payload:{_status:-1,_result:e},_init:R}},t.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=$.transition;$.transition={};try{e()}finally{$.transition=t}},t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},t.useCallback=function(e,t){return T.current.useCallback(e,t)},t.useContext=function(e){return T.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return T.current.useDeferredValue(e)},t.useEffect=function(e,t){return T.current.useEffect(e,t)},t.useId=function(){return T.current.useId()},t.useImperativeHandle=function(e,t,n){return T.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return T.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return T.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return T.current.useMemo(e,t)},t.useReducer=function(e,t,n){return T.current.useReducer(e,t,n)},t.useRef=function(e){return T.current.useRef(e)},t.useState=function(e){return T.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return T.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return T.current.useTransition()},t.version="18.2.0"},827378:(e,t,n)=>{e.exports=n(541535)},824246:(e,t,n)=>{e.exports=n(371426)},511151:(e,t,n)=>{n.d(t,{Z:()=>s,a:()=>a});var r=n(667294);const o={},i=r.createContext(o);function a(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);