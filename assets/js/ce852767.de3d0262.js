/*! For license information please see ce852767.de3d0262.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[800323],{216245:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var r=n(824246),o=n(511151);const i={id:"troubleshooting",title:"Troubleshooting Auth",description:"Guidance for various issues that one might run into when setting up authentication"},s=void 0,a={id:"auth/troubleshooting",title:"Troubleshooting Auth",description:"Guidance for various issues that one might run into when setting up authentication",source:"@site/../docs/auth/troubleshooting.md",sourceDirName:"auth",slug:"/auth/troubleshooting",permalink:"/docs/auth/troubleshooting",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/auth/troubleshooting.md",tags:[],version:"current",frontMatter:{id:"troubleshooting",title:"Troubleshooting Auth",description:"Guidance for various issues that one might run into when setting up authentication"},sidebar:"docs",previous:{title:"Auto Logout",permalink:"/docs/auth/autologout"},next:{title:"Overview",permalink:"/docs/permissions/overview"}},u={},l=[{value:"Sign-in fails with &quot;... provider is not configured to support sign-in&quot;",id:"sign-in-fails-with--provider-is-not-configured-to-support-sign-in",level:2},{value:"Auth fails with &quot;Auth provider registered for ... is misconfigured&quot;",id:"auth-fails-with-auth-provider-registered-for--is-misconfigured",level:2},{value:"Auth fails with &quot;Login failed; caused by NotAllowedError: Origin &#39;...&#39; is not allowed&quot;",id:"auth-fails-with-login-failed-caused-by-notallowederror-origin--is-not-allowed",level:2},{value:"Sign-in fails with the error &quot;User not found&quot;",id:"sign-in-fails-with-the-error-user-not-found",level:2},{value:"General troubleshooting",id:"general-troubleshooting",level:2},{value:"Stepping through authentication manually",id:"stepping-through-authentication-manually",level:3},{value:"Inspecting the refresh call",id:"inspecting-the-refresh-call",level:3},{value:"Inspecting the contents of a Backstage token",id:"inspecting-the-contents-of-a-backstage-token",level:3}];function c(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,o.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.p,{children:"Auth is tricky and doesn't always work as expected. Below you'll find some of the common\nproblems one might run into when setting up authentication, as well as some general\ntroubleshooting tips."}),"\n",(0,r.jsx)(t.h2,{id:"sign-in-fails-with--provider-is-not-configured-to-support-sign-in",children:'Sign-in fails with "... provider is not configured to support sign-in"'}),"\n",(0,r.jsxs)(t.p,{children:["This happens if you try to sign in using an auth provider that has not been\nconfigured to allow sign-in. See the ",(0,r.jsx)(t.a,{href:"/docs/auth/identity-resolver",children:"Sign-in Identities and Resolvers"}),"\npage for information about how to configure and customize sign-in."]}),"\n",(0,r.jsx)(t.p,{children:"As part of the 1.1 release of Backstage we removed the default implementations\nof all sign-in resolvers. This was a necessary security fix as well as a step\ntowards providing more clarity in the configuration of the sign-in process.\nYou may encounter this error if you are upgrading from a previous version, in\nwhich case you would need to configure a sign-in resolver as described above."}),"\n",(0,r.jsx)(t.h2,{id:"auth-fails-with-auth-provider-registered-for--is-misconfigured",children:'Auth fails with "Auth provider registered for ... is misconfigured"'}),"\n",(0,r.jsx)(t.p,{children:"This will typically only happen during development, as in a production build the auth\nbackend will fail to start up altogether if a provider is misconfigured."}),"\n",(0,r.jsxs)(t.p,{children:["Double check that your configuration for the provider is correct. Note that environment variables\nsuch as ",(0,r.jsx)(t.code,{children:"AUTH_OAUTH2_CLIENT_ID"})," must be set and will ",(0,r.jsx)(t.strong,{children:"NOT"})," be picked up from ",(0,r.jsx)(t.code,{children:".env"})," files.\nYou can use the ",(0,r.jsx)(t.code,{children:"yarn backstage-cli config:print --lax"})," command to print your local configuration."]}),"\n",(0,r.jsxs)(t.p,{children:["The backend logs should also provide insight into why the configuration of the provider\nfails. In working setup the backend should log something like ",(0,r.jsx)(t.code,{children:'"Configuring provider, oauth2"'}),",\nwhile it with otherwise log a warning like ",(0,r.jsx)(t.code,{children:'"Skipping oauth2 auth provider, ..."'}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"auth-fails-with-login-failed-caused-by-notallowederror-origin--is-not-allowed",children:"Auth fails with \"Login failed; caused by NotAllowedError: Origin '...' is not allowed\""}),"\n",(0,r.jsxs)(t.p,{children:["This will happen if the origin of the configured ",(0,r.jsx)(t.code,{children:"app.baseUrl"})," in the auth backend does not\nmatch the origin that the frontend is being accessed at. Make sure that ",(0,r.jsx)(t.code,{children:"app.baseUrl"})," matches\nwhat a user sees in the browser address bar."]}),"\n",(0,r.jsxs)(t.p,{children:["If you wish to support multiple different origins at once, there is an experimental configuration\nthat lets you do this. The ",(0,r.jsx)(t.code,{children:"auth.experimentalExtraAllowedOrigins"})," key accepts a list of origin\nglob patterns where sign-in should be allowed from."]}),"\n",(0,r.jsx)(t.h2,{id:"sign-in-fails-with-the-error-user-not-found",children:'Sign-in fails with the error "User not found"'}),"\n",(0,r.jsxs)(t.p,{children:["Many built-in sign-in resolvers require user entities to be present in the catalog. This\nerror is encountered if authentication is successful, but a matching user entity is not\npresent in the catalog. If you wish to enable sign-in without having users be represented\nin the catalog data, see the method that's documented in the\n",(0,r.jsx)(t.a,{href:"/docs/auth/identity-resolver#sign-in-without-users-in-the-catalog",children:"sign-in resolver documentation"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["If you want to customize this error message, you can create a custom sign-in resolver and\ncatch the ",(0,r.jsx)(t.code,{children:"NotFoundError"})," thrown by ",(0,r.jsx)(t.code,{children:"ctx.signInWithCatalogUser"})," or ",(0,r.jsx)(t.code,{children:"ctx.findCatalogUser"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"general-troubleshooting",children:"General troubleshooting"}),"\n",(0,r.jsx)(t.p,{children:"This section contains some general troubleshooting tips."}),"\n",(0,r.jsx)(t.h3,{id:"stepping-through-authentication-manually",children:"Stepping through authentication manually"}),"\n",(0,r.jsx)(t.p,{children:"Authentication happens in a popup window that redirects to the identity providers authorization\nendpoint. Once auth is complete the identity provider will redirect back to the auth backend,\nwhich immediately serves a simple HTML page that posts the result back to the main window, which\nthen closes the popup."}),"\n",(0,r.jsxs)(t.p,{children:["Because the popup is closed automatically it can sometimes be difficult to inspect the auth\nflow, especially if one wants to debug the cookies that are being set. One way around this is to\nmanually head to the ",(0,r.jsx)(t.code,{children:"/start"})," endpoint of the provider, which is the page that the popup will\npoint to initially. For example, if you want to troubleshoot GitHub auth locally, you'd head\nto ",(0,r.jsx)(t.code,{children:"http://localhost:7007/api/auth/github/start?env=development"}),". Note that the ",(0,r.jsx)(t.code,{children:"env"})," parameter\nneeds to be set, and it's possible that you may need to set the ",(0,r.jsx)(t.code,{children:"scope"})," parameter for some providers\nas well."]}),"\n",(0,r.jsxs)(t.p,{children:["Once you've stepped through the auth flow you should end up at the ",(0,r.jsx)(t.code,{children:"/handler/frame"})," endpoint, which displays\nan empty page. This is where the result is normally posted back to the main window, but since we've\nreached it using the manual flow that won't happen. You can still inspect the result though, both\nby viewing the source code of the page, or printing the value of the ",(0,r.jsx)(t.code,{children:"authResponse"})," variable in the console."]}),"\n",(0,r.jsx)(t.h3,{id:"inspecting-the-refresh-call",children:"Inspecting the refresh call"}),"\n",(0,r.jsxs)(t.p,{children:["If you're running into problems with session persistence, such as users being signed out when reloading\nthe page, it will be something that's going wrong with the call to the ",(0,r.jsx)(t.code,{children:"/refresh"})," endpoint of the\nauth provider. Head to the network inspector and filter by ",(0,r.jsx)(t.code,{children:"/refresh"}),". Find the ",(0,r.jsx)(t.code,{children:"GET"})," request towards\n",(0,r.jsx)(t.code,{children:"<backend.baseUrl>/api/auth/<provider>/refresh"})," and inspect the request."]}),"\n",(0,r.jsx)(t.p,{children:"Note that extra calls to the refresh endpoint may be made by the frontend in order to check whether\nauth providers have an existing session. This means that there might be multiple calls, including some\nthat are failing. Make sure you're looking at the refresh call to the provider that you're troubleshooting,\nand don't worry about other failing refresh calls."}),"\n",(0,r.jsx)(t.h3,{id:"inspecting-the-contents-of-a-backstage-token",children:"Inspecting the contents of a Backstage token"}),"\n",(0,r.jsx)(t.p,{children:"The Backstage token that's issues during sign-in is a plain JWT. You can inspect the contents using\nany tool that supports JWTs, or you can parse the payload yourself in for example the browser console\nor a Node.js REPL:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:"atob(token.split('.')[1]);\n"})})]})}function h(e={}){const{wrapper:t}={...(0,o.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},371426:(e,t,n)=>{var r=n(827378),o=Symbol.for("react.element"),i=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,a=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,u={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,n){var r,i={},l=null,c=null;for(r in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(c=t.ref),t)s.call(t,r)&&!u.hasOwnProperty(r)&&(i[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===i[r]&&(i[r]=t[r]);return{$$typeof:o,type:e,key:l,ref:c,props:i,_owner:a.current}}t.Fragment=i,t.jsx=l,t.jsxs=l},541535:(e,t)=>{var n=Symbol.for("react.element"),r=Symbol.for("react.portal"),o=Symbol.for("react.fragment"),i=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),u=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),h=Symbol.for("react.memo"),d=Symbol.for("react.lazy"),f=Symbol.iterator;var p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},g=Object.assign,y={};function m(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||p}function b(){}function v(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||p}m.prototype.isReactComponent={},m.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},m.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},b.prototype=m.prototype;var w=v.prototype=new b;w.constructor=v,g(w,m.prototype),w.isPureReactComponent=!0;var x=Array.isArray,j=Object.prototype.hasOwnProperty,k={current:null},_={key:!0,ref:!0,__self:!0,__source:!0};function S(e,t,r){var o,i={},s=null,a=null;if(null!=t)for(o in void 0!==t.ref&&(a=t.ref),void 0!==t.key&&(s=""+t.key),t)j.call(t,o)&&!_.hasOwnProperty(o)&&(i[o]=t[o]);var u=arguments.length-2;if(1===u)i.children=r;else if(1<u){for(var l=Array(u),c=0;c<u;c++)l[c]=arguments[c+2];i.children=l}if(e&&e.defaultProps)for(o in u=e.defaultProps)void 0===i[o]&&(i[o]=u[o]);return{$$typeof:n,type:e,key:s,ref:a,props:i,_owner:k.current}}function E(e){return"object"==typeof e&&null!==e&&e.$$typeof===n}var T=/\/+/g;function C(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function O(e,t,o,i,s){var a=typeof e;"undefined"!==a&&"boolean"!==a||(e=null);var u=!1;if(null===e)u=!0;else switch(a){case"string":case"number":u=!0;break;case"object":switch(e.$$typeof){case n:case r:u=!0}}if(u)return s=s(u=e),e=""===i?"."+C(u,0):i,x(s)?(o="",null!=e&&(o=e.replace(T,"$&/")+"/"),O(s,t,o,"",(function(e){return e}))):null!=s&&(E(s)&&(s=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(s,o+(!s.key||u&&u.key===s.key?"":(""+s.key).replace(T,"$&/")+"/")+e)),t.push(s)),1;if(u=0,i=""===i?".":i+":",x(e))for(var l=0;l<e.length;l++){var c=i+C(a=e[l],l);u+=O(a,t,o,c,s)}else if(c=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"==typeof c)for(e=c.call(e),l=0;!(a=e.next()).done;)u+=O(a=a.value,t,o,c=i+C(a,l++),s);else if("object"===a)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return u}function R(e,t,n){if(null==e)return e;var r=[],o=0;return O(e,r,"","",(function(e){return t.call(n,e,o++)})),r}function I(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var A={current:null},$={transition:null},P={ReactCurrentDispatcher:A,ReactCurrentBatchConfig:$,ReactCurrentOwner:k};t.Children={map:R,forEach:function(e,t,n){R(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return R(e,(function(){t++})),t},toArray:function(e){return R(e,(function(e){return e}))||[]},only:function(e){if(!E(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=m,t.Fragment=o,t.Profiler=s,t.PureComponent=v,t.StrictMode=i,t.Suspense=c,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=P,t.cloneElement=function(e,t,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var o=g({},e.props),i=e.key,s=e.ref,a=e._owner;if(null!=t){if(void 0!==t.ref&&(s=t.ref,a=k.current),void 0!==t.key&&(i=""+t.key),e.type&&e.type.defaultProps)var u=e.type.defaultProps;for(l in t)j.call(t,l)&&!_.hasOwnProperty(l)&&(o[l]=void 0===t[l]&&void 0!==u?u[l]:t[l])}var l=arguments.length-2;if(1===l)o.children=r;else if(1<l){u=Array(l);for(var c=0;c<l;c++)u[c]=arguments[c+2];o.children=u}return{$$typeof:n,type:e.type,key:i,ref:s,props:o,_owner:a}},t.createContext=function(e){return(e={$$typeof:u,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},t.createElement=S,t.createFactory=function(e){var t=S.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:l,render:e}},t.isValidElement=E,t.lazy=function(e){return{$$typeof:d,_payload:{_status:-1,_result:e},_init:I}},t.memo=function(e,t){return{$$typeof:h,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=$.transition;$.transition={};try{e()}finally{$.transition=t}},t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},t.useCallback=function(e,t){return A.current.useCallback(e,t)},t.useContext=function(e){return A.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return A.current.useDeferredValue(e)},t.useEffect=function(e,t){return A.current.useEffect(e,t)},t.useId=function(){return A.current.useId()},t.useImperativeHandle=function(e,t,n){return A.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return A.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return A.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return A.current.useMemo(e,t)},t.useReducer=function(e,t,n){return A.current.useReducer(e,t,n)},t.useRef=function(e){return A.current.useRef(e)},t.useState=function(e){return A.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return A.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return A.current.useTransition()},t.version="18.2.0"},827378:(e,t,n)=>{e.exports=n(541535)},824246:(e,t,n)=>{e.exports=n(371426)},511151:(e,t,n)=>{n.d(t,{Z:()=>a,a:()=>s});var r=n(667294);const o={},i=r.createContext(o);function s(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);