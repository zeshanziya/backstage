/*! For license information please see f2bdee62.9babe88d.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[259282],{505504:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>d,frontMatter:()=>s,metadata:()=>c,toc:()=>a});var n=r(824246),o=r(511151);const s={id:"root-http-router",title:"Root Http Router Service",sidebar_label:"Root Http Router",description:"Documentation for the Root Http Router service"},i=void 0,c={id:"backend-system/core-services/root-http-router",title:"Root Http Router Service",description:"Documentation for the Root Http Router service",source:"@site/../docs/backend-system/core-services/root-http-router.md",sourceDirName:"backend-system/core-services",slug:"/backend-system/core-services/root-http-router",permalink:"/docs/backend-system/core-services/root-http-router",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/backend-system/core-services/root-http-router.md",tags:[],version:"current",frontMatter:{id:"root-http-router",title:"Root Http Router Service",sidebar_label:"Root Http Router",description:"Documentation for the Root Http Router service"},sidebar:"docs",previous:{title:"Root Config",permalink:"/docs/backend-system/core-services/root-config"},next:{title:"Root Lifecycle",permalink:"/docs/backend-system/core-services/root-lifecycle"}},u={},a=[{value:"Using the service",id:"using-the-service",level:2},{value:"Configuring the service",id:"configuring-the-service",level:2}];function l(e){const t={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["The root HTTP router is a service that allows you to register routes on the root of the backend service. This is useful for things like health checks, or other routes that you want to expose on the root of the backend service. It is used as the base router that backs the ",(0,n.jsx)(t.code,{children:"httpRouter"})," service and starts the Node.js HTTP server on backend startup. Most likely you won't need to use this service directly, but rather use the ",(0,n.jsx)(t.code,{children:"httpRouter"})," service."]}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"/api/:pluginId/"})," path prefix is reserved for use by plugins to register their own routes via the ",(0,n.jsx)(t.a,{href:"/docs/backend-system/core-services/http-router",children:"HttpRouter"})," service."]}),"\n",(0,n.jsx)(t.h2,{id:"using-the-service",children:"Using the service"}),"\n",(0,n.jsxs)(t.p,{children:["The following example shows how to get the root HTTP router service in your ",(0,n.jsx)(t.code,{children:"example"})," backend plugin to register a health check route."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { Router } from 'express';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        rootHttpRouter: coreServices.rootHttpRouter,\n      },\n      async init({ rootHttpRouter }) {\n        const router = Router();\n        router.get('/readiness', (request, response) => {\n          response.send('OK');\n        });\n\n        rootHttpRouter.use('/health', router);\n      },\n    });\n  },\n});\n"})}),"\n",(0,n.jsx)(t.h2,{id:"configuring-the-service",children:"Configuring the service"}),"\n",(0,n.jsxs)(t.p,{children:["There's additional options that you can pass to configure the root HTTP Router service. These options are passed when you call ",(0,n.jsx)(t.code,{children:"createBackend"}),"."]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"indexPath"})," - optional path to forward all unmatched requests to. Defaults to ",(0,n.jsx)(t.code,{children:"/api/app"})," which is the ",(0,n.jsx)(t.code,{children:"app-backend"})," plugin responsible for serving the frontend application through the backend."]}),"\n"]}),"\n",(0,n.jsxs)(t.li,{children:["\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"configure"})," - this is an optional function that you can use to configure the ",(0,n.jsx)(t.code,{children:"express"})," instance. This is useful if you want to add your own middleware to the root router, such as logging, or other things that you want to do before the request is handled by the backend. It's also useful to override the order in which middleware is applied."]}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["You can configure the root HTTP Router service by passing the options to the ",(0,n.jsx)(t.code,{children:"createBackend"})," function."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",children:"import { rootHttpRouterServiceFactory } from '@backstage/backend-app-api';\n\nconst backend = createBackend();\n\nbackend.add(\n  rootHttpRouterServiceFactory({\n    configure: ({ app, middleware, routes, config, logger, lifecycle }) => {\n      // the built in middleware is provided through an option in the configure function\n      app.use(middleware.helmet());\n      app.use(middleware.cors());\n      app.use(middleware.compression());\n\n      // you can add you your own middleware in here\n      app.use(custom.logging());\n\n      // here the routes that are registered by other plugins\n      app.use(routes);\n\n      // some other middleware that comes after the other routes\n      app.use(middleware.notFound());\n      app.use(middleware.error());\n    },\n  }),\n);\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Note that requests towards ",(0,n.jsx)(t.code,{children:"/api/*"})," will never be handled by the ",(0,n.jsx)(t.code,{children:"routes"})," handler unless a matching plugin exists, and will instead typically falling through to the ",(0,n.jsx)(t.code,{children:"middleware.notFound()"})," handler. That is the case regardless of whether there is a configured ",(0,n.jsx)(t.code,{children:"indexPath"})," or not."]}),"\n",(0,n.jsxs)(t.p,{children:["The root HTTP Router service also allows for configuration of the underlying Node.js HTTP server object. This is useful for modifying settings on the HTTP server itself, such as server ",(0,n.jsx)(t.a,{href:"https://nodejs.org/api/http.html#servertimeout",children:"timeout"}),", ",(0,n.jsx)(t.a,{href:"https://nodejs.org/api/http.html#serverkeepalivetimeout",children:"keepAliveTimeout"}),", and ",(0,n.jsx)(t.a,{href:"https://nodejs.org/api/http.html#serverheaderstimeout",children:"headersTimeout"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["A ",(0,n.jsx)(t.code,{children:"applyDefaults"})," helper is also made available to use the default app/router configuration while still enabling custom server configuration"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",children:"import { rootHttpRouterServiceFactory } from '@backstage/backend-app-api';\n\nconst backend = createBackend();\n\nbackend.add(\n  rootHttpRouterServiceFactory({\n    configure: ({ server, applyDefaults }) => {\n      // apply default app/router configuration\n      applyDefaults();\n\n      // customize the Node.js HTTP Server timeouts\n      server.keepAliveTimeout = 65 * 1000;\n      server.headersTimeout = 66 * 1000;\n    },\n  }),\n);\n"})})]})}function d(e={}){const{wrapper:t}={...(0,o.a)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},371426:(e,t,r)=>{var n=r(827378),o=Symbol.for("react.element"),s=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,c=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,u={key:!0,ref:!0,__self:!0,__source:!0};function a(e,t,r){var n,s={},a=null,l=null;for(n in void 0!==r&&(a=""+r),void 0!==t.key&&(a=""+t.key),void 0!==t.ref&&(l=t.ref),t)i.call(t,n)&&!u.hasOwnProperty(n)&&(s[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===s[n]&&(s[n]=t[n]);return{$$typeof:o,type:e,key:a,ref:l,props:s,_owner:c.current}}t.Fragment=s,t.jsx=a,t.jsxs=a},541535:(e,t)=>{var r=Symbol.for("react.element"),n=Symbol.for("react.portal"),o=Symbol.for("react.fragment"),s=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),c=Symbol.for("react.provider"),u=Symbol.for("react.context"),a=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),f=Symbol.iterator;var h={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},y=Object.assign,m={};function v(e,t,r){this.props=e,this.context=t,this.refs=m,this.updater=r||h}function g(){}function b(e,t,r){this.props=e,this.context=t,this.refs=m,this.updater=r||h}v.prototype.isReactComponent={},v.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},v.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},g.prototype=v.prototype;var k=b.prototype=new g;k.constructor=b,y(k,v.prototype),k.isPureReactComponent=!0;var x=Array.isArray,j=Object.prototype.hasOwnProperty,_={current:null},w={key:!0,ref:!0,__self:!0,__source:!0};function R(e,t,n){var o,s={},i=null,c=null;if(null!=t)for(o in void 0!==t.ref&&(c=t.ref),void 0!==t.key&&(i=""+t.key),t)j.call(t,o)&&!w.hasOwnProperty(o)&&(s[o]=t[o]);var u=arguments.length-2;if(1===u)s.children=n;else if(1<u){for(var a=Array(u),l=0;l<u;l++)a[l]=arguments[l+2];s.children=a}if(e&&e.defaultProps)for(o in u=e.defaultProps)void 0===s[o]&&(s[o]=u[o]);return{$$typeof:r,type:e,key:i,ref:c,props:s,_owner:_.current}}function S(e){return"object"==typeof e&&null!==e&&e.$$typeof===r}var T=/\/+/g;function E(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function P(e,t,o,s,i){var c=typeof e;"undefined"!==c&&"boolean"!==c||(e=null);var u=!1;if(null===e)u=!0;else switch(c){case"string":case"number":u=!0;break;case"object":switch(e.$$typeof){case r:case n:u=!0}}if(u)return i=i(u=e),e=""===s?"."+E(u,0):s,x(i)?(o="",null!=e&&(o=e.replace(T,"$&/")+"/"),P(i,t,o,"",(function(e){return e}))):null!=i&&(S(i)&&(i=function(e,t){return{$$typeof:r,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(i,o+(!i.key||u&&u.key===i.key?"":(""+i.key).replace(T,"$&/")+"/")+e)),t.push(i)),1;if(u=0,s=""===s?".":s+":",x(e))for(var a=0;a<e.length;a++){var l=s+E(c=e[a],a);u+=P(c,t,o,l,i)}else if(l=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"==typeof l)for(e=l.call(e),a=0;!(c=e.next()).done;)u+=P(c=c.value,t,o,l=s+E(c,a++),i);else if("object"===c)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return u}function C(e,t,r){if(null==e)return e;var n=[],o=0;return P(e,n,"","",(function(e){return t.call(r,e,o++)})),n}function H(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var $={current:null},O={transition:null},I={ReactCurrentDispatcher:$,ReactCurrentBatchConfig:O,ReactCurrentOwner:_};t.Children={map:C,forEach:function(e,t,r){C(e,(function(){t.apply(this,arguments)}),r)},count:function(e){var t=0;return C(e,(function(){t++})),t},toArray:function(e){return C(e,(function(e){return e}))||[]},only:function(e){if(!S(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=v,t.Fragment=o,t.Profiler=i,t.PureComponent=b,t.StrictMode=s,t.Suspense=l,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=I,t.cloneElement=function(e,t,n){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var o=y({},e.props),s=e.key,i=e.ref,c=e._owner;if(null!=t){if(void 0!==t.ref&&(i=t.ref,c=_.current),void 0!==t.key&&(s=""+t.key),e.type&&e.type.defaultProps)var u=e.type.defaultProps;for(a in t)j.call(t,a)&&!w.hasOwnProperty(a)&&(o[a]=void 0===t[a]&&void 0!==u?u[a]:t[a])}var a=arguments.length-2;if(1===a)o.children=n;else if(1<a){u=Array(a);for(var l=0;l<a;l++)u[l]=arguments[l+2];o.children=u}return{$$typeof:r,type:e.type,key:s,ref:i,props:o,_owner:c}},t.createContext=function(e){return(e={$$typeof:u,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:c,_context:e},e.Consumer=e},t.createElement=R,t.createFactory=function(e){var t=R.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:a,render:e}},t.isValidElement=S,t.lazy=function(e){return{$$typeof:p,_payload:{_status:-1,_result:e},_init:H}},t.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=O.transition;O.transition={};try{e()}finally{O.transition=t}},t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},t.useCallback=function(e,t){return $.current.useCallback(e,t)},t.useContext=function(e){return $.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return $.current.useDeferredValue(e)},t.useEffect=function(e,t){return $.current.useEffect(e,t)},t.useId=function(){return $.current.useId()},t.useImperativeHandle=function(e,t,r){return $.current.useImperativeHandle(e,t,r)},t.useInsertionEffect=function(e,t){return $.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return $.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return $.current.useMemo(e,t)},t.useReducer=function(e,t,r){return $.current.useReducer(e,t,r)},t.useRef=function(e){return $.current.useRef(e)},t.useState=function(e){return $.current.useState(e)},t.useSyncExternalStore=function(e,t,r){return $.current.useSyncExternalStore(e,t,r)},t.useTransition=function(){return $.current.useTransition()},t.version="18.2.0"},827378:(e,t,r)=>{e.exports=r(541535)},824246:(e,t,r)=>{e.exports=r(371426)},511151:(e,t,r)=>{r.d(t,{Z:()=>c,a:()=>i});var n=r(667294);const o={},s=n.createContext(o);function i(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),n.createElement(s.Provider,{value:t},e.children)}}}]);