/*! For license information please see 7c59564d.b19e6f69.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[824611],{209746:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var r=t(824246),a=t(511151);const o={id:"backend-plugin",title:"Backend plugins",description:"Creating and Developing Backend plugins"},i=void 0,s={id:"plugins/backend-plugin",title:"Backend plugins",description:"Creating and Developing Backend plugins",source:"@site/../docs/plugins/backend-plugin.md",sourceDirName:"plugins",slug:"/plugins/backend-plugin",permalink:"/docs/plugins/backend-plugin",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/plugins/backend-plugin.md",tags:[],version:"current",frontMatter:{id:"backend-plugin",title:"Backend plugins",description:"Creating and Developing Backend plugins"},sidebar:"docs",previous:{title:"Proxying",permalink:"/docs/plugins/proxying"},next:{title:"Call Existing API",permalink:"/docs/plugins/call-existing-api"}},c={},l=[{value:"Creating a Backend Plugin",id:"creating-a-backend-plugin",level:2},{value:"Developing your Backend Plugin",id:"developing-your-backend-plugin",level:2},{value:"Making Use of a Database",id:"making-use-of-a-database",level:2},{value:"Making Use of the User&#39;s Identity",id:"making-use-of-the-users-identity",level:2}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",p:"p",pre:"pre",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"This page describes the process of creating and managing backend plugins in your\nBackstage repository."}),"\n",(0,r.jsx)(n.h2,{id:"creating-a-backend-plugin",children:"Creating a Backend Plugin"}),"\n",(0,r.jsx)(n.p,{children:"A new, bare-bones backend plugin package can be created by issuing the following\ncommand in your Backstage repository root:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"yarn new --select backend-plugin\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Please also see the ",(0,r.jsx)(n.code,{children:"--help"})," flag for the ",(0,r.jsx)(n.code,{children:"new"})," command for some\nfurther options that are available, notably the ",(0,r.jsx)(n.code,{children:"--scope"})," and ",(0,r.jsx)(n.code,{children:"--no-private"}),"\nflags that control naming and publishing of the newly created package. Your repo\nroot ",(0,r.jsx)(n.code,{children:"package.json"})," will probably also have some default values already set up\nfor these."]}),"\n",(0,r.jsxs)(n.p,{children:["You will be asked to supply a name for the plugin. This is an identifier that\nwill be part of the NPM package name, so make it short and containing only\nlowercase characters separated by dashes, for example ",(0,r.jsx)(n.code,{children:"carmen"}),", if it's a\npackage that adds an integration with a system named Carmen, for example. The\nfull NPM package name would then be something like\n",(0,r.jsx)(n.code,{children:"@internal/plugin-carmen-backend"}),", depending on the other flags passed to the\n",(0,r.jsx)(n.code,{children:"new"})," command, and your settings for the ",(0,r.jsx)(n.code,{children:"new"})," command in\nyour root ",(0,r.jsx)(n.code,{children:"package.json"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Creating the plugin will take a little while, so be patient. It will helpfully\nrun the initial installation and build commands, so that your package is ready\nto be hacked on! It will be located in a new folder in your ",(0,r.jsx)(n.code,{children:"plugins"})," directory,\nin this example ",(0,r.jsx)(n.code,{children:"plugins/carmen-backend"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"For simple development purposes, a backend plugin can actually be started in a\nstandalone mode. You can do a first-light test of your service:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"cd plugins/carmen-backend\nLEGACY_BACKEND_START=true yarn start\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Note: ",(0,r.jsx)(n.code,{children:"LEGACY_BACKEND_START=true"})," is needed while we transition fully to the ",(0,r.jsx)(n.a,{href:"/docs/backend-system/",children:"New Backend System"}),". The templates have not been migrated yet; you can track this in ",(0,r.jsx)(n.a,{href:"https://github.com/backstage/backstage/issues/21288",children:"issue 21288"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["This will think for a bit, and then say ",(0,r.jsx)(n.code,{children:"Listening on :7007"}),". In a different\nterminal window, now run"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"curl localhost:7007/carmen/health\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This should return ",(0,r.jsx)(n.code,{children:'{"status":"ok"}'}),". Success! Press ",(0,r.jsx)(n.code,{children:"Ctrl + c"})," to stop it\nagain."]}),"\n",(0,r.jsx)(n.h2,{id:"developing-your-backend-plugin",children:"Developing your Backend Plugin"}),"\n",(0,r.jsxs)(n.p,{children:["A freshly created backend plugin does basically nothing, in terms of the overall\napp. It has a small set of basic dependencies and exposes an Express router in\n",(0,r.jsx)(n.code,{children:"src/service/router.ts"}),". This is where you will start adding routes and\nconnecting those to actual underlying functionality. But nothing in your\nBackstage application / backend exposes it."]}),"\n",(0,r.jsx)(n.p,{children:"To actually attach and run the plugin router, you will make some modifications\nto your backend."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# From your Backstage root directory\nyarn --cwd packages/backend add @internal/plugin-carmen-backend@^0.1.0 # Change this to match the plugin's package.json\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Create a new file named ",(0,r.jsx)(n.code,{children:"packages/backend/src/plugins/carmen.ts"}),", and add the\nfollowing to it"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { createRouter } from '@internal/plugin-carmen-backend';\nimport { Router } from 'express';\nimport { PluginEnvironment } from '../types';\n\nexport default async function createPlugin(\n  env: PluginEnvironment,\n): Promise<Router> {\n  // Here is where you will add all of the required initialization code that\n  // your backend plugin needs to be able to start!\n\n  // The env contains a lot of goodies, but our router currently only\n  // needs a logger\n  return await createRouter({\n    logger: env.logger,\n  });\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["And finally, wire this into the overall backend router. Edit\n",(0,r.jsx)(n.code,{children:"packages/backend/src/index.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import carmen from './plugins/carmen';\n// ...\nasync function main() {\n  // ...\n  const carmenEnv = useHotMemoize(module, () => createEnv('carmen'));\n  apiRouter.use('/carmen', await carmen(carmenEnv));\n"})}),"\n",(0,r.jsxs)(n.p,{children:["After you start the backend (e.g. using ",(0,r.jsx)(n.code,{children:"yarn start-backend"})," from the repo\nroot), you should be able to fetch data from it."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# Note the extra /api here\ncurl localhost:7007/api/carmen/health\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This should return ",(0,r.jsx)(n.code,{children:'{"status":"ok"}'})," like before. Success!"]}),"\n",(0,r.jsx)(n.h2,{id:"making-use-of-a-database",children:"Making Use of a Database"}),"\n",(0,r.jsx)(n.p,{children:"The Backstage backend comes with a builtin facility for SQL database access.\nMost plugins that have persistence needs will choose to make use of this\nfacility, so that Backstage operators can manage database needs uniformly."}),"\n",(0,r.jsxs)(n.p,{children:["As part of the environment object that is passed to your ",(0,r.jsx)(n.code,{children:"createPlugin"}),"\nfunction, there is a ",(0,r.jsx)(n.code,{children:"database"})," field. You can use that to get a\n",(0,r.jsx)(n.a,{href:"http://knexjs.org/",children:"Knex"})," connection object."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// in packages/backend/src/plugins/carmen.ts\nexport default async function createPlugin(\n  env: PluginEnvironment,\n): Promise<Router> {\n  const db: Knex<any, unknown[]> = await env.database.getClient();\n\n  // You will then pass this client into your actual plugin implementation\n  // code, maybe similar to the following:\n  const model = new CarmenDatabaseModel(db);\n  return await createRouter({\n    model: model,\n    logger: env.logger,\n  });\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You may note that the ",(0,r.jsx)(n.code,{children:"getClient"})," call has no parameters. This is because all\nplugin database needs are configured under the ",(0,r.jsx)(n.code,{children:"backend.database"})," config key of\nyour ",(0,r.jsx)(n.code,{children:"app-config.yaml"}),". The framework may even make sure behind the scenes that\nthe logical database is created automatically if it doesn't exist, based on\nrules that the Backstage operator decides on."]}),"\n",(0,r.jsx)(n.p,{children:"The framework does not handle database schema migrations for you, however. The\nbuiltin plugins in the main repo have chosen to use the Knex library to manage\nschema migrations as well, but you can do so in any manner that you see fit."}),"\n",(0,r.jsxs)(n.p,{children:["See the ",(0,r.jsx)(n.a,{href:"http://knexjs.org/",children:"Knex library documentation"})," for examples and\ndetails on how to write schema migrations and perform SQL queries against your\ndatabase.."]}),"\n",(0,r.jsx)(n.h2,{id:"making-use-of-the-users-identity",children:"Making Use of the User's Identity"}),"\n",(0,r.jsx)(n.p,{children:"The Backstage backend comes with a facility for retrieving the identity of the\nlogged in user."}),"\n",(0,r.jsxs)(n.p,{children:["As part of the environment object that is passed to your ",(0,r.jsx)(n.code,{children:"createPlugin"}),"\nfunction, there is a ",(0,r.jsx)(n.code,{children:"identity"})," field. You can use that to get an identity\nfrom the request."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// in packages/backend/src/plugins/carmen.ts\nexport default async function createPlugin(\n  env: PluginEnvironment,\n): Promise<Router> {\n  return await createRouter({\n    model: model,\n    logger: env.logger,\n    identity: env.identity,\n  });\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"The plugin can then extract the identity from the request."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"export async function createRouter(\n  options: RouterOptions,\n): Promise<express.Router> {\n  const router = Router();\n  const { identity } = options;\n\n  router.post('/example', async (req, res) => {\n    const userIdentity = await identity.getIdentity({ request: req });\n    ...\n  });\n"})})]})}function d(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},371426:(e,n,t)=>{var r=t(827378),a=Symbol.for("react.element"),o=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,s=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,n,t){var r,o={},l=null,u=null;for(r in void 0!==t&&(l=""+t),void 0!==n.key&&(l=""+n.key),void 0!==n.ref&&(u=n.ref),n)i.call(n,r)&&!c.hasOwnProperty(r)&&(o[r]=n[r]);if(e&&e.defaultProps)for(r in n=e.defaultProps)void 0===o[r]&&(o[r]=n[r]);return{$$typeof:a,type:e,key:l,ref:u,props:o,_owner:s.current}}n.Fragment=o,n.jsx=l,n.jsxs=l},541535:(e,n)=>{var t=Symbol.for("react.element"),r=Symbol.for("react.portal"),a=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),s=Symbol.for("react.provider"),c=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),h=Symbol.iterator;var f={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},g=Object.assign,m={};function y(e,n,t){this.props=e,this.context=n,this.refs=m,this.updater=t||f}function b(){}function k(e,n,t){this.props=e,this.context=n,this.refs=m,this.updater=t||f}y.prototype.isReactComponent={},y.prototype.setState=function(e,n){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,n,"setState")},y.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},b.prototype=y.prototype;var x=k.prototype=new b;x.constructor=k,g(x,y.prototype),x.isPureReactComponent=!0;var j=Array.isArray,v=Object.prototype.hasOwnProperty,w={current:null},_={key:!0,ref:!0,__self:!0,__source:!0};function S(e,n,r){var a,o={},i=null,s=null;if(null!=n)for(a in void 0!==n.ref&&(s=n.ref),void 0!==n.key&&(i=""+n.key),n)v.call(n,a)&&!_.hasOwnProperty(a)&&(o[a]=n[a]);var c=arguments.length-2;if(1===c)o.children=r;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];o.children=l}if(e&&e.defaultProps)for(a in c=e.defaultProps)void 0===o[a]&&(o[a]=c[a]);return{$$typeof:t,type:e,key:i,ref:s,props:o,_owner:w.current}}function E(e){return"object"==typeof e&&null!==e&&e.$$typeof===t}var C=/\/+/g;function R(e,n){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var n={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return n[e]}))}(""+e.key):n.toString(36)}function P(e,n,a,o,i){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var c=!1;if(null===e)c=!0;else switch(s){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case t:case r:c=!0}}if(c)return i=i(c=e),e=""===o?"."+R(c,0):o,j(i)?(a="",null!=e&&(a=e.replace(C,"$&/")+"/"),P(i,n,a,"",(function(e){return e}))):null!=i&&(E(i)&&(i=function(e,n){return{$$typeof:t,type:e.type,key:n,ref:e.ref,props:e.props,_owner:e._owner}}(i,a+(!i.key||c&&c.key===i.key?"":(""+i.key).replace(C,"$&/")+"/")+e)),n.push(i)),1;if(c=0,o=""===o?".":o+":",j(e))for(var l=0;l<e.length;l++){var u=o+R(s=e[l],l);c+=P(s,n,a,u,i)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=h&&e[h]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),l=0;!(s=e.next()).done;)c+=P(s=s.value,n,a,u=o+R(s,l++),i);else if("object"===s)throw n=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===n?"object with keys {"+Object.keys(e).join(", ")+"}":n)+"). If you meant to render a collection of children, use an array instead.");return c}function T(e,n,t){if(null==e)return e;var r=[],a=0;return P(e,r,"","",(function(e){return n.call(t,e,a++)})),r}function B(e){if(-1===e._status){var n=e._result;(n=n()).then((function(n){0!==e._status&&-1!==e._status||(e._status=1,e._result=n)}),(function(n){0!==e._status&&-1!==e._status||(e._status=2,e._result=n)})),-1===e._status&&(e._status=0,e._result=n)}if(1===e._status)return e._result.default;throw e._result}var N={current:null},$={transition:null},I={ReactCurrentDispatcher:N,ReactCurrentBatchConfig:$,ReactCurrentOwner:w};n.Children={map:T,forEach:function(e,n,t){T(e,(function(){n.apply(this,arguments)}),t)},count:function(e){var n=0;return T(e,(function(){n++})),n},toArray:function(e){return T(e,(function(e){return e}))||[]},only:function(e){if(!E(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},n.Component=y,n.Fragment=a,n.Profiler=i,n.PureComponent=k,n.StrictMode=o,n.Suspense=u,n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=I,n.cloneElement=function(e,n,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var a=g({},e.props),o=e.key,i=e.ref,s=e._owner;if(null!=n){if(void 0!==n.ref&&(i=n.ref,s=w.current),void 0!==n.key&&(o=""+n.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(l in n)v.call(n,l)&&!_.hasOwnProperty(l)&&(a[l]=void 0===n[l]&&void 0!==c?c[l]:n[l])}var l=arguments.length-2;if(1===l)a.children=r;else if(1<l){c=Array(l);for(var u=0;u<l;u++)c[u]=arguments[u+2];a.children=c}return{$$typeof:t,type:e.type,key:o,ref:i,props:a,_owner:s}},n.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:s,_context:e},e.Consumer=e},n.createElement=S,n.createFactory=function(e){var n=S.bind(null,e);return n.type=e,n},n.createRef=function(){return{current:null}},n.forwardRef=function(e){return{$$typeof:l,render:e}},n.isValidElement=E,n.lazy=function(e){return{$$typeof:p,_payload:{_status:-1,_result:e},_init:B}},n.memo=function(e,n){return{$$typeof:d,type:e,compare:void 0===n?null:n}},n.startTransition=function(e){var n=$.transition;$.transition={};try{e()}finally{$.transition=n}},n.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},n.useCallback=function(e,n){return N.current.useCallback(e,n)},n.useContext=function(e){return N.current.useContext(e)},n.useDebugValue=function(){},n.useDeferredValue=function(e){return N.current.useDeferredValue(e)},n.useEffect=function(e,n){return N.current.useEffect(e,n)},n.useId=function(){return N.current.useId()},n.useImperativeHandle=function(e,n,t){return N.current.useImperativeHandle(e,n,t)},n.useInsertionEffect=function(e,n){return N.current.useInsertionEffect(e,n)},n.useLayoutEffect=function(e,n){return N.current.useLayoutEffect(e,n)},n.useMemo=function(e,n){return N.current.useMemo(e,n)},n.useReducer=function(e,n,t){return N.current.useReducer(e,n,t)},n.useRef=function(e){return N.current.useRef(e)},n.useState=function(e){return N.current.useState(e)},n.useSyncExternalStore=function(e,n,t){return N.current.useSyncExternalStore(e,n,t)},n.useTransition=function(){return N.current.useTransition()},n.version="18.2.0"},827378:(e,n,t)=>{e.exports=t(541535)},824246:(e,n,t)=>{e.exports=t(371426)},511151:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>i});var r=t(667294);const a={},o=r.createContext(a);function i(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);