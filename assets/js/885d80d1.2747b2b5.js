/*! For license information please see 885d80d1.2747b2b5.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[911612],{246936:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var r=t(824246),i=t(511151);const o={id:"index",title:"Core Backend Service APIs",sidebar_label:"Overview",description:"Core backend service APIs"},s=void 0,c={id:"backend-system/core-services/index",title:"Core Backend Service APIs",description:"Core backend service APIs",source:"@site/../docs/backend-system/core-services/01-index.md",sourceDirName:"backend-system/core-services",slug:"/backend-system/core-services/index",permalink:"/docs/backend-system/core-services/index",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/backend-system/core-services/01-index.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"index",title:"Core Backend Service APIs",sidebar_label:"Overview",description:"Core backend service APIs"},sidebar:"docs",previous:{title:"Migration Guide",permalink:"/docs/backend-system/building-plugins-and-modules/migrating"},next:{title:"Introduction",permalink:"/docs/frontend-system/"}},a={},l=[{value:"HTTP Router Service",id:"http-router-service",level:2},{value:"Using the service",id:"using-the-service",level:3},{value:"Configuring the service",id:"configuring-the-service",level:3},{value:"Root HTTP Router",id:"root-http-router",level:2},{value:"Using the service",id:"using-the-service-1",level:3},{value:"Configuring the service",id:"configuring-the-service-1",level:3},{value:"Root Config",id:"root-config",level:2},{value:"Using the service",id:"using-the-service-2",level:3},{value:"Configuring the service",id:"configuring-the-service-2",level:3},{value:"Logging",id:"logging",level:2},{value:"Using the service",id:"using-the-service-3",level:3},{value:"Root Logger",id:"root-logger",level:3},{value:"Configuring the service",id:"configuring-the-service-3",level:3},{value:"Cache",id:"cache",level:2},{value:"Using the service",id:"using-the-service-4",level:3},{value:"Database",id:"database",level:2},{value:"Using the service",id:"using-the-service-5",level:3},{value:"Discovery",id:"discovery",level:2},{value:"Using the service",id:"using-the-service-6",level:3},{value:"Identity",id:"identity",level:2},{value:"Using the service",id:"using-the-service-7",level:3},{value:"Configuring the service",id:"configuring-the-service-4",level:3},{value:"Lifecycle",id:"lifecycle",level:2},{value:"Using the service",id:"using-the-service-8",level:3},{value:"Root Lifecycle",id:"root-lifecycle",level:2},{value:"Configure the service",id:"configure-the-service",level:3},{value:"Permissions",id:"permissions",level:2},{value:"Using the service",id:"using-the-service-9",level:3},{value:"Scheduler",id:"scheduler",level:2},{value:"Using the service",id:"using-the-service-10",level:3},{value:"URL Readers",id:"url-readers",level:2},{value:"Using the service",id:"using-the-service-11",level:3}];function d(e){const n=Object.assign({p:"p",a:"a",code:"code",pre:"pre",h2:"h2",h3:"h3",ul:"ul",li:"li"},(0,i.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["The default backend provides several ",(0,r.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/master/packages/backend-plugin-api/src/services/definitions/coreServices.ts",children:"core services"})," out of the box which includes access to configuration, logging, URL Readers, databases and more."]}),"\n",(0,r.jsxs)(n.p,{children:["All core services are available through the ",(0,r.jsx)(n.code,{children:"coreServices"})," namespace in the ",(0,r.jsx)(n.code,{children:"@backstage/backend-plugin-api"})," package."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { coreServices } from '@backstage/backend-plugin-api';\n"})}),"\n",(0,r.jsx)(n.h2,{id:"http-router-service",children:"HTTP Router Service"}),"\n",(0,r.jsx)(n.p,{children:"One of the most common services is the HTTP router service which is used to expose HTTP endpoints for other plugins to consume."}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to register a HTTP router for the ",(0,r.jsx)(n.code,{children:"example"})," plugin.\nThis single route will be available at the ",(0,r.jsx)(n.code,{children:"/api/example/hello"})," path."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { Router } from 'express';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: { http: coreServices.httpRouter },\n      async init({ http }) {\n        const router = Router();\n        router.get('/hello', (_req, res) => {\n          res.status(200).json({ hello: 'world' });\n        });\n        // Registers the router at the /api/example path\n        http.use(router);\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuring-the-service",children:"Configuring the service"}),"\n",(0,r.jsxs)(n.p,{children:["There's additional configuration that you can optionally pass to setup the ",(0,r.jsx)(n.code,{children:"httpRouter"})," core service."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getPath"})," - Can be used to generate a path for each plugin. Currently defaults to ",(0,r.jsx)(n.code,{children:"/api/${pluginId}"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["You can configure these additional options by adding an override for the core service when calling ",(0,r.jsx)(n.code,{children:"createBackend"})," like follows:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { httpRouterServiceFactory } from '@backstage/backend-app-api';\n\nconst backend = createBackend();\n\nbackend.add(\n  httpRouterServiceFactory({\n    getPath: (pluginId: string) => `/plugins/${pluginId}`,\n  }),\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"root-http-router",children:"Root HTTP Router"}),"\n",(0,r.jsxs)(n.p,{children:["The root HTTP router is a service that allows you to register routes on the root of the backend service. This is useful for things like health checks, or other routes that you want to expose on the root of the backend service. It is used as the base router that backs the ",(0,r.jsx)(n.code,{children:"httpRouter"})," service. Most likely you won't need to use this service directly, but rather use the ",(0,r.jsx)(n.code,{children:"httpRouter"})," service."]}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-1",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get the root HTTP router service in your ",(0,r.jsx)(n.code,{children:"example"})," backend plugin to register a health check route."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { Router } from 'express';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        rootHttpRouter: coreServices.rootHttpRouter,\n      },\n      async init({ rootHttpRouter }) {\n        const router = Router();\n        router.get('/health', (request, response) => {\n          response.send('OK');\n        });\n\n        rootHttpRouter.use(router);\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuring-the-service-1",children:"Configuring the service"}),"\n",(0,r.jsxs)(n.p,{children:["There's additional options that you can pass to configure the root HTTP Router service. These options are passed when you call ",(0,r.jsx)(n.code,{children:"createBackend"}),"."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"indexPath"})," - optional path to forward all unmatched requests to. Defaults to ",(0,r.jsx)(n.code,{children:"/api/app"})," which is the ",(0,r.jsx)(n.code,{children:"app-backend"})," plugin responsible for serving the frontend application through the backend."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"configure"})," - this is an optional function that you can use to configure the ",(0,r.jsx)(n.code,{children:"express"})," instance. This is useful if you want to add your own middleware to the root router, such as logging, or other things that you want to do before the request is handled by the backend. It's also useful to override the order in which middleware is applied."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["You can configure the root HTTP Router service by passing the options to the ",(0,r.jsx)(n.code,{children:"createBackend"})," function."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { rootHttpRouterServiceFactory } from '@backstage/backend-app-api';\n\nconst backend = createBackend();\n\nbackend.add(\n  rootHttpRouterServiceFactory({\n    configure: ({ app, middleware, routes, config, logger, lifecycle }) => {\n      // the built in middleware is provided through an option in the configure function\n      app.use(middleware.helmet());\n      app.use(middleware.cors());\n      app.use(middleware.compression());\n\n      // you can add you your own middleware in here\n      app.use(custom.logging());\n\n      // here the routes that are registered by other plugins\n      app.use(routes);\n\n      // some other middleware that comes after the other routes\n      app.use(middleware.notFound());\n      app.use(middleware.error());\n    },\n  }),\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"root-config",children:"Root Config"}),"\n",(0,r.jsxs)(n.p,{children:["This service allows you to read configuration values out of your ",(0,r.jsx)(n.code,{children:"app-config"})," YAML files."]}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-2",children:"Using the service"}),"\n",(0,r.jsx)(n.p,{children:"The following example shows how you can use the default config service to be able to get a config value, and then log it to the console."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        log: coreServices.logger,\n        config: coreServices.rootConfig,\n      },\n      async init({ log, config }) {\n        const baseUrl = config.getString('backend.baseUrl');\n        log.warn(`The backend is running at ${baseUrl}`);\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuring-the-service-2",children:"Configuring the service"}),"\n",(0,r.jsxs)(n.p,{children:["There's additional configuration that you can optionally pass to setup the ",(0,r.jsx)(n.code,{children:"config"})," core service."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"argv"})," - Override the arguments that are passed to the config loader, instead of using ",(0,r.jsx)(n.code,{children:"process.argv"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"remote"})," - Configure remote configuration loading"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["You can configure these additional options by adding an override for the core service when calling ",(0,r.jsx)(n.code,{children:"createBackend"})," like follows:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { rootConfigServiceFactory } from '@backstage/backend-app-api';\n\nconst backend = createBackend();\n\nbackend.add(\n  rootConfigServiceFactory({\n    argv: [\n      '--config',\n      '/backstage/app-config.development.yaml',\n      '--config',\n      '/backstage/app-config.yaml',\n    ],\n    remote: { reloadIntervalSeconds: 60 },\n  }),\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"logging",children:"Logging"}),"\n",(0,r.jsx)(n.p,{children:"This service allows plugins to output logging information. There are actually two logger services: a root logger, and a plugin logger which is bound to individual plugins, so that you will get nice messages with the plugin ID referenced in the log lines."}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-3",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get the logger in your ",(0,r.jsx)(n.code,{children:"example"})," backend plugin and create a warning message that will be printed nicely to the console."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        log: coreServices.logger,\n      },\n      async init({ log }) {\n        log.warn(\"Here's a nice log line that's a warning!\");\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"root-logger",children:"Root Logger"}),"\n",(0,r.jsx)(n.p,{children:"The root logger is the logger that is used by other root services. It's where the implementation lies for creating child loggers around the backstage ecosystem including child loggers for plugins with the correct metadata and annotations."}),"\n",(0,r.jsx)(n.p,{children:"If you want to override the implementation for logging across all of the backend, this is the service that you should override."}),"\n",(0,r.jsx)(n.h3,{id:"configuring-the-service-3",children:"Configuring the service"}),"\n",(0,r.jsx)(n.p,{children:"The following example is how you can override the root logger service to add additional metadata to all log lines."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { coreServices } from '@backstage/backend-plugin-api';\nimport { WinstonLogger } from '@backstage/backend-app-api';\n\nconst backend = createBackend();\n\nbackend.add(\n  createServiceFactory({\n    service: coreServices.rootLogger,\n    deps: {\n      config: coreServices.rootConfig,\n    },\n    async factory({ config }) {\n      const logger = WinstonLogger.create({\n        meta: {\n          service: 'backstage',\n          // here's some additional information that is not part of the\n          // original implementation\n          podName: 'myk8spod',\n        },\n        level: process.env.LOG_LEVEL || 'info',\n        format:\n          process.env.NODE_ENV === 'production'\n            ? format.json()\n            : WinstonLogger.colorFormat(),\n        transports: [new transports.Console()],\n      });\n\n      return logger;\n    },\n  }),\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"cache",children:"Cache"}),"\n",(0,r.jsx)(n.p,{children:"This service lets your plugin interact with a cache. It is bound to your plugin too, so that you will only set and get values in your plugin's private namespace."}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-4",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get a cache client in your ",(0,r.jsx)(n.code,{children:"example"})," backend plugin and setting and getting values from the cache."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        cache: coreServices.cache,\n      },\n      async init({ cache }) {\n        const { key, value } = { key: 'test:key', value: 'bob' };\n        await cache.set(key, value, { ttl: 1000 });\n\n        // .. some other stuff.\n\n        await cache.get(key); // 'bob'\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"database",children:"Database"}),"\n",(0,r.jsxs)(n.p,{children:["This service lets your plugins get a ",(0,r.jsx)(n.code,{children:"knex"})," client hooked up to a database which is configured in your ",(0,r.jsx)(n.code,{children:"app-config"})," YAML files, for your persistence needs."]}),"\n",(0,r.jsxs)(n.p,{children:["If there's no config provided in ",(0,r.jsx)(n.code,{children:"backend.database"})," then you will automatically get a simple in-memory SQLite 3 database for your plugin whose contents will be lost when the service restarts."]}),"\n",(0,r.jsx)(n.p,{children:"This service is scoped per plugin too, so that table names do not conflict across plugins."}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-5",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get access to the database service in your ",(0,r.jsx)(n.code,{children:"example"})," backend plugin and getting a client for interacting with the database. It also runs some migrations from a certain directory for your plugin."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { resolvePackagePath } from '@backstage/backend-common';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        database: coreServices.database,\n      },\n      async init({ database }) {\n        const client = await database.getClient();\n        const migrationsDir = resolvePackagePath(\n          '@internal/my-plugin',\n          'migrations',\n        );\n        if (!database.migrations?.skip) {\n          await client.migrate.latest({\n            directory: migrationsDir,\n          });\n        }\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"discovery",children:"Discovery"}),"\n",(0,r.jsxs)(n.p,{children:["When building plugins, you might find that you will need to look up another plugin's base URL to be able to communicate with it. This could be for example an HTTP route or some ",(0,r.jsx)(n.code,{children:"ws"})," protocol URL. For this we have a discovery service which can provide both internal and external base URLs for a given a plugin ID."]}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-6",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get the discovery service in your ",(0,r.jsx)(n.code,{children:"example"})," backend plugin and making a request to both the internal and external base URLs for the ",(0,r.jsx)(n.code,{children:"derp"})," plugin."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { fetch } from 'node-fetch';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        discovery: coreServices.discovery,\n      },\n      async init({ discovery }) {\n        const url = await discovery.getBaseUrl('derp'); // can also use discovery.getExternalBaseUrl to retrieve external URL\n        const response = await fetch(`${url}/hello`);\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"identity",children:"Identity"}),"\n",(0,r.jsxs)(n.p,{children:["When working with backend plugins, you might find that you will need to interact with the ",(0,r.jsx)(n.code,{children:"auth-backend"})," plugin to both authenticate backstage tokens, and to deconstruct them to get the user's entity ref and/or ownership claims out of them."]}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-7",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get the identity service in your ",(0,r.jsx)(n.code,{children:"example"})," backend plugin and retrieve the user's entity ref and ownership claims for the incoming request."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { Router } from 'express';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        identity: coreServices.identity,\n        http: coreServices.httpRouter,\n      },\n      async init({ http, identity }) {\n        const router = Router();\n        router.get('/test-me', (request, response) => {\n          // use the identity service to pull out the header from the request and get the user\n          const {\n            identity: { userEntityRef, ownershipEntityRefs },\n          } = await identity.getIdentity({\n            request,\n          });\n\n          // send the decoded and validated things back to the user\n          response.json({\n            userEntityRef,\n            ownershipEntityRefs,\n          });\n        });\n\n        http.use(router);\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuring-the-service-4",children:"Configuring the service"}),"\n",(0,r.jsxs)(n.p,{children:["There's additional configuration that you can optionally pass to setup the ",(0,r.jsx)(n.code,{children:"identity"})," core service."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"issuer"})," - Set an optional issuer for validation of the JWT token"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"algorithms"})," - ",(0,r.jsx)(n.code,{children:"alg"})," header for validation of the JWT token, defaults to ",(0,r.jsx)(n.code,{children:"ES256"}),". More info on supported algorithms can be found in the ",(0,r.jsxs)(n.a,{href:"https://github.com/panva/jose",children:[(0,r.jsx)(n.code,{children:"jose"})," library documentation"]})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["You can configure these additional options by adding an override for the core service when calling ",(0,r.jsx)(n.code,{children:"createBackend"})," like follows:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { identityServiceFactory } from '@backstage/backend-app-api';\n\nconst backend = createBackend();\n\nbackend.add(\n  identityServiceFactory({\n    issuer: 'backstage',\n    algorithms: ['ES256', 'RS256'],\n  }),\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"lifecycle",children:"Lifecycle"}),"\n",(0,r.jsxs)(n.p,{children:["This service allows your plugins to register hooks for cleaning up resources as the service is shutting down (e.g. when a pod is being torn down, or when pressing ",(0,r.jsx)(n.code,{children:"Ctrl+C"})," during local development). Other core services also leverage this same mechanism internally to stop themselves cleanly."]}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-8",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get the lifecycle service in your ",(0,r.jsx)(n.code,{children:"example"})," backend plugin to clean up a long running interval when the service is shutting down."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        lifecycle: coreServices.lifecycle,\n        logger: coreServices.logger,\n      },\n      async init({ lifecycle, logger }) {\n        // some example work that we want to stop when shutting down\n        const interval = setInterval(async () => {\n          await fetch('http://google.com/keepalive').then(r => r.json());\n          // do some other stuff.\n        }, 1000);\n\n        lifecycle.addShutdownHook(() => clearInterval(interval));\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"root-lifecycle",children:"Root Lifecycle"}),"\n",(0,r.jsx)(n.p,{children:"This service is the same as the lifecycle service, but should only be used by the root services. This is also where the implementation for the actual lifecycle hooks are collected and executed, so if you want to override the implementation of how those are processed, you should override this service."}),"\n",(0,r.jsx)(n.h3,{id:"configure-the-service",children:"Configure the service"}),"\n",(0,r.jsx)(n.p,{children:"The following example shows how to override the default implementation of the lifecycle service with something that listens on different process events to the original."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"class MyCustomLifecycleService implements RootLifecycleService {\n  constructor(private readonly logger: LoggerService) {}\n\n  #isCalled = false;\n  #shutdownTasks: Array<{\n    hook: LifecycleServiceShutdownHook;\n    options?: LifecycleServiceShutdownOptions;\n  }> = [];\n\n  addShutdownHook(\n    hook: LifecycleServiceShutdownHook,\n    options?: LifecycleServiceShutdownOptions,\n  ): void {\n    this.#shutdownTasks.push({ hook, options });\n  }\n\n  async shutdown(): Promise<void> {\n    if (this.#isCalled) {\n      return;\n    }\n    this.#isCalled = true;\n\n    this.logger.info(`Running ${this.#shutdownTasks.length} shutdown tasks...`);\n    await Promise.all(\n      this.#shutdownTasks.map(async ({ hook, options }) => {\n        const logger = options?.logger ?? this.logger;\n        try {\n          await hook();\n          logger.info(`Shutdown hook succeeded`);\n        } catch (error) {\n          logger.error(`Shutdown hook failed, ${error}`);\n        }\n      }),\n    );\n  }\n}\n\nconst backend = createBackend();\n\nbackend.add(\n  createServiceFactory({\n    service: coreServices.rootLifecycle,\n    deps: {\n      logger: coreServices.rootLogger,\n    },\n    async factory({ logger }) {\n      return new MyCustomLifecycleService(logger);\n    },\n  }),\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"permissions",children:"Permissions"}),"\n",(0,r.jsxs)(n.p,{children:["This service allows your plugins to ask ",(0,r.jsx)(n.a,{href:"https://backstage.io/docs/permissions/overview",children:"the permissions framework"})," for authorization of user actions."]}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-9",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get the permissions service in your ",(0,r.jsx)(n.code,{children:"example"})," backend to check to see if the user is allowed to perform a certain action with a custom permission rule."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { Router } from 'express';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        permissions: coreServices.permissions,\n        http: coreServices.httpRouter,\n      },\n      async init({ permissions, http }) {\n        const router = Router();\n        router.get('/test-me', (request, response) => {\n          // use the identity service to pull out the token from request headers\n          const { token } = await identity.getIdentity({\n            request,\n          });\n\n          // ask the permissions framework what the decision is for the permission\n          const permissionResponse = await permissions.authorize(\n            [\n              {\n                permission: myCustomPermission,\n              },\n            ],\n            { token },\n          );\n        });\n\n        http.use(router);\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"scheduler",children:"Scheduler"}),"\n",(0,r.jsx)(n.p,{children:"When writing plugins, you sometimes want to have things running on a schedule, or something similar to cron jobs that are distributed through instances that your backend plugin is running on. We supply a task scheduler for this purpose that is scoped per plugin so that you can create these tasks and orchestrate their execution."}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-10",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get the scheduler service in your ",(0,r.jsx)(n.code,{children:"example"})," backend to issue a scheduled task that runs across your instances at a given interval."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { fetch } from 'node-fetch';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        scheduler: coreServices.scheduler,\n      },\n      async init({ scheduler }) {\n        await scheduler.scheduleTask({\n          frequency: { minutes: 10 },\n          timeout: { seconds: 30 },\n          id: 'ping-google',\n          fn: async () => {\n            await fetch('http://google.com/ping');\n          },\n        });\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"url-readers",children:"URL Readers"}),"\n",(0,r.jsxs)(n.p,{children:["Plugins will require communication with certain integrations that users have configured. Popular integrations are things like Version Control Systems (VSC), such as GitHub, BitBucket GitLab etc. These integrations are configured in the ",(0,r.jsx)(n.code,{children:"integrations"})," section of the ",(0,r.jsx)(n.code,{children:"app-config.yaml"})," file."]}),"\n",(0,r.jsx)(n.p,{children:"These URL readers are basically wrappers with authentication for files and folders that could be stored in these VCS repositories."}),"\n",(0,r.jsx)(n.h3,{id:"using-the-service-11",children:"Using the service"}),"\n",(0,r.jsxs)(n.p,{children:["The following example shows how to get the URL Reader service in your ",(0,r.jsx)(n.code,{children:"example"})," backend plugin to read a file and a directory from a GitHub repository."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport os from 'os';\n\ncreateBackendPlugin({\n  pluginId: 'example',\n  register(env) {\n    env.registerInit({\n      deps: {\n        urlReader: coreServices.urlReader,\n      },\n      async init({ urlReader }) {\n        const buffer = await urlReader\n          .read('https://github.com/backstage/backstage/blob/master/README.md')\n          .then(r => r.buffer());\n\n        const tmpDir = os.tmpdir();\n        const directory = await urlReader\n          .readTree(\n            'https://github.com/backstage/backstage/tree/master/packages/backend',\n          )\n          .then(tree => tree.dir({ targetDir: tmpDir }));\n      },\n    });\n  },\n});\n"})})]})}const u=function(e={}){const{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,r.jsx)(n,Object.assign({},e,{children:(0,r.jsx)(d,e)})):d(e)}},371426:(e,n,t)=>{var r=t(827378),i=Symbol.for("react.element"),o=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,c=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,a={key:!0,ref:!0,__self:!0,__source:!0};function l(e,n,t){var r,o={},l=null,d=null;for(r in void 0!==t&&(l=""+t),void 0!==n.key&&(l=""+n.key),void 0!==n.ref&&(d=n.ref),n)s.call(n,r)&&!a.hasOwnProperty(r)&&(o[r]=n[r]);if(e&&e.defaultProps)for(r in n=e.defaultProps)void 0===o[r]&&(o[r]=n[r]);return{$$typeof:i,type:e,key:l,ref:d,props:o,_owner:c.current}}n.Fragment=o,n.jsx=l,n.jsxs=l},541535:(e,n)=>{var t=Symbol.for("react.element"),r=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),c=Symbol.for("react.provider"),a=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),d=Symbol.for("react.suspense"),u=Symbol.for("react.memo"),h=Symbol.for("react.lazy"),g=Symbol.iterator;var p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},f=Object.assign,v={};function m(e,n,t){this.props=e,this.context=n,this.refs=v,this.updater=t||p}function y(){}function x(e,n,t){this.props=e,this.context=n,this.refs=v,this.updater=t||p}m.prototype.isReactComponent={},m.prototype.setState=function(e,n){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,n,"setState")},m.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},y.prototype=m.prototype;var b=x.prototype=new y;b.constructor=x,f(b,m.prototype),b.isPureReactComponent=!0;var k=Array.isArray,j=Object.prototype.hasOwnProperty,w={current:null},S={key:!0,ref:!0,__self:!0,__source:!0};function R(e,n,r){var i,o={},s=null,c=null;if(null!=n)for(i in void 0!==n.ref&&(c=n.ref),void 0!==n.key&&(s=""+n.key),n)j.call(n,i)&&!S.hasOwnProperty(i)&&(o[i]=n[i]);var a=arguments.length-2;if(1===a)o.children=r;else if(1<a){for(var l=Array(a),d=0;d<a;d++)l[d]=arguments[d+2];o.children=l}if(e&&e.defaultProps)for(i in a=e.defaultProps)void 0===o[i]&&(o[i]=a[i]);return{$$typeof:t,type:e,key:s,ref:c,props:o,_owner:w.current}}function T(e){return"object"==typeof e&&null!==e&&e.$$typeof===t}var P=/\/+/g;function _(e,n){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var n={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return n[e]}))}(""+e.key):n.toString(36)}function C(e,n,i,o,s){var c=typeof e;"undefined"!==c&&"boolean"!==c||(e=null);var a=!1;if(null===e)a=!0;else switch(c){case"string":case"number":a=!0;break;case"object":switch(e.$$typeof){case t:case r:a=!0}}if(a)return s=s(a=e),e=""===o?"."+_(a,0):o,k(s)?(i="",null!=e&&(i=e.replace(P,"$&/")+"/"),C(s,n,i,"",(function(e){return e}))):null!=s&&(T(s)&&(s=function(e,n){return{$$typeof:t,type:e.type,key:n,ref:e.ref,props:e.props,_owner:e._owner}}(s,i+(!s.key||a&&a.key===s.key?"":(""+s.key).replace(P,"$&/")+"/")+e)),n.push(s)),1;if(a=0,o=""===o?".":o+":",k(e))for(var l=0;l<e.length;l++){var d=o+_(c=e[l],l);a+=C(c,n,i,d,s)}else if(d=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=g&&e[g]||e["@@iterator"])?e:null}(e),"function"==typeof d)for(e=d.call(e),l=0;!(c=e.next()).done;)a+=C(c=c.value,n,i,d=o+_(c,l++),s);else if("object"===c)throw n=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===n?"object with keys {"+Object.keys(e).join(", ")+"}":n)+"). If you meant to render a collection of children, use an array instead.");return a}function I(e,n,t){if(null==e)return e;var r=[],i=0;return C(e,r,"","",(function(e){return n.call(t,e,i++)})),r}function U(e){if(-1===e._status){var n=e._result;(n=n()).then((function(n){0!==e._status&&-1!==e._status||(e._status=1,e._result=n)}),(function(n){0!==e._status&&-1!==e._status||(e._status=2,e._result=n)})),-1===e._status&&(e._status=0,e._result=n)}if(1===e._status)return e._result.default;throw e._result}var L={current:null},B={transition:null},E={ReactCurrentDispatcher:L,ReactCurrentBatchConfig:B,ReactCurrentOwner:w};n.Children={map:I,forEach:function(e,n,t){I(e,(function(){n.apply(this,arguments)}),t)},count:function(e){var n=0;return I(e,(function(){n++})),n},toArray:function(e){return I(e,(function(e){return e}))||[]},only:function(e){if(!T(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},n.Component=m,n.Fragment=i,n.Profiler=s,n.PureComponent=x,n.StrictMode=o,n.Suspense=d,n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=E,n.cloneElement=function(e,n,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var i=f({},e.props),o=e.key,s=e.ref,c=e._owner;if(null!=n){if(void 0!==n.ref&&(s=n.ref,c=w.current),void 0!==n.key&&(o=""+n.key),e.type&&e.type.defaultProps)var a=e.type.defaultProps;for(l in n)j.call(n,l)&&!S.hasOwnProperty(l)&&(i[l]=void 0===n[l]&&void 0!==a?a[l]:n[l])}var l=arguments.length-2;if(1===l)i.children=r;else if(1<l){a=Array(l);for(var d=0;d<l;d++)a[d]=arguments[d+2];i.children=a}return{$$typeof:t,type:e.type,key:o,ref:s,props:i,_owner:c}},n.createContext=function(e){return(e={$$typeof:a,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:c,_context:e},e.Consumer=e},n.createElement=R,n.createFactory=function(e){var n=R.bind(null,e);return n.type=e,n},n.createRef=function(){return{current:null}},n.forwardRef=function(e){return{$$typeof:l,render:e}},n.isValidElement=T,n.lazy=function(e){return{$$typeof:h,_payload:{_status:-1,_result:e},_init:U}},n.memo=function(e,n){return{$$typeof:u,type:e,compare:void 0===n?null:n}},n.startTransition=function(e){var n=B.transition;B.transition={};try{e()}finally{B.transition=n}},n.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},n.useCallback=function(e,n){return L.current.useCallback(e,n)},n.useContext=function(e){return L.current.useContext(e)},n.useDebugValue=function(){},n.useDeferredValue=function(e){return L.current.useDeferredValue(e)},n.useEffect=function(e,n){return L.current.useEffect(e,n)},n.useId=function(){return L.current.useId()},n.useImperativeHandle=function(e,n,t){return L.current.useImperativeHandle(e,n,t)},n.useInsertionEffect=function(e,n){return L.current.useInsertionEffect(e,n)},n.useLayoutEffect=function(e,n){return L.current.useLayoutEffect(e,n)},n.useMemo=function(e,n){return L.current.useMemo(e,n)},n.useReducer=function(e,n,t){return L.current.useReducer(e,n,t)},n.useRef=function(e){return L.current.useRef(e)},n.useState=function(e){return L.current.useState(e)},n.useSyncExternalStore=function(e,n,t){return L.current.useSyncExternalStore(e,n,t)},n.useTransition=function(){return L.current.useTransition()},n.version="18.2.0"},827378:(e,n,t)=>{e.exports=t(541535)},824246:(e,n,t)=>{e.exports=t(371426)},511151:(e,n,t)=>{t.d(n,{Zo:()=>c,ah:()=>o});var r=t(667294);const i=r.createContext({});function o(e){const n=r.useContext(i);return r.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}const s={};function c({components:e,children:n,disableParentContext:t}){let c;return c=t?"function"==typeof e?e({}):e||s:o(e),r.createElement(i.Provider,{value:c},n)}}}]);