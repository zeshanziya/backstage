/*! For license information please see 79d210df.e3da95b8.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[507940],{679862:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var r=n(824246),o=n(511151);const a={id:"easy-auth",title:"Azure EasyAuth Provider",sidebar_label:"Azure Easy Auth",description:"Adding Azure's EasyAuth Proxy as an authentication provider in Backstage"},i=void 0,s={id:"auth/microsoft/easy-auth",title:"Azure EasyAuth Provider",description:"Adding Azure's EasyAuth Proxy as an authentication provider in Backstage",source:"@site/../docs/auth/microsoft/azure-easyauth.md",sourceDirName:"auth/microsoft",slug:"/auth/microsoft/easy-auth",permalink:"/docs/auth/microsoft/easy-auth",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/auth/microsoft/azure-easyauth.md",tags:[],version:"current",frontMatter:{id:"easy-auth",title:"Azure EasyAuth Provider",sidebar_label:"Azure Easy Auth",description:"Adding Azure's EasyAuth Proxy as an authentication provider in Backstage"},sidebar:"docs",previous:{title:"Azure",permalink:"/docs/auth/microsoft/provider"},next:{title:"Bitbucket",permalink:"/docs/auth/bitbucket/provider"}},u={},c=[{value:"Backstage Changes",id:"backstage-changes",level:2},{value:"Frontend Changes",id:"frontend-changes",level:2},{value:"Azure Configuration",id:"azure-configuration",level:2},{value:"Azure App Services",id:"azure-app-services",level:3}];function l(e){const t=Object.assign({p:"p",code:"code",h2:"h2",pre:"pre",a:"a",h3:"h3"},(0,o.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["The Backstage ",(0,r.jsx)(t.code,{children:"core-plugin-api"})," package comes with a Microsoft authentication provider that can authenticate users using Microsoft Entra ID (formerly Azure Active Directory) for PaaS service hosted in Azure that support Easy Auth, such as Azure App Services."]}),"\n",(0,r.jsx)(t.h2,{id:"backstage-changes",children:"Backstage Changes"}),"\n",(0,r.jsxs)(t.p,{children:["Add the following into your ",(0,r.jsx)(t.code,{children:"app-config.yaml"})," or ",(0,r.jsx)(t.code,{children:"app-config.production.yaml"})," file"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"auth:\n  environment: development\n  providers:\n    azure-easyauth:\n      development: {}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Add a ",(0,r.jsx)(t.code,{children:"providerFactories"})," entry to the router in\n",(0,r.jsx)(t.code,{children:"packages/backend/src/plugins/auth.ts"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"import { providers } from '@backstage/plugin-auth-backend';\n\nexport default async function createPlugin(\n  env: PluginEnvironment,\n): Promise<Router> {\n  const authProviderFactories = {\n    'azure-easyauth': providers.easyAuth.create({\n      signIn: {\n        resolver: async (info, ctx) => {\n          const {\n            fullProfile: { id },\n          } = info.result;\n\n          if (!id) {\n            throw new Error('User profile contained no id');\n          }\n\n          return await ctx.signInWithCatalogUser({\n            annotations: {\n              'graph.microsoft.com/user-id': id,\n            },\n          });\n        },\n      },\n    }),\n  };\n\n  return await createRouter({\n    logger: env.logger,\n    config: env.config,\n    database: env.database,\n    discovery: env.discovery,\n    tokenManager: env.tokenManager,\n    providerFactories: authProviderFactories,\n  });\n}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Now the backend is ready to serve auth requests on the\n",(0,r.jsx)(t.code,{children:"/api/auth/azure-easyauth/refresh"})," endpoint. All that's left is to update the frontend\nsign-in mechanism to poll that endpoint through the IAP, on the user's behalf."]}),"\n",(0,r.jsx)(t.h2,{id:"frontend-changes",children:"Frontend Changes"}),"\n",(0,r.jsxs)(t.p,{children:["To use this component, you'll need to configure the app's ",(0,r.jsx)(t.code,{children:"SignInPage"}),".\nIt is recommended to use the ",(0,r.jsx)(t.code,{children:"ProxiedSignInPage"})," for this provider when running in Azure, However for local development (or any other scenario running outside of Azure), you'll want to set up something different.\nFor the closest experience to Easy Auth, you could set up the ",(0,r.jsx)(t.code,{children:"microsoft"})," provider locally, but that will requires setting up App Registrations & secrets which may be locked down by your organisation, in which case it may be easier to use guest login locally.\nSee ",(0,r.jsx)(t.a,{href:"/docs/auth/#sign-in-with-proxy-providers",children:"Sign-In with Proxy Providers"})," for more details."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",metastring:'title="packages/app/src/App.tsx"',children:"/* highlight-add-next-line */\nimport { ProxiedSignInPage } from '@backstage/core-components';\n\nconst app = createApp({\n  /* highlight-add-start */\n  components: {\n    SignInPage: props => {\n      const configApi = useApi(configApiRef);\n      if (configApi.getString('auth.environment') !== 'development') {\n        return <ProxiedSignInPage {...props} provider=\"azure-easyauth\" />;\n      }\n      return (\n        <SignInPage\n          {...props}\n          providers={['guest', 'custom']}\n          title=\"Select a sign-in method\"\n          align=\"center\"\n        />\n      );\n    },\n  },\n  /* highlight-add-end */\n  // ..\n});\n"})}),"\n",(0,r.jsx)(t.h2,{id:"azure-configuration",children:"Azure Configuration"}),"\n",(0,r.jsx)(t.p,{children:"How to configure azure depends on the Azure service you're using to host Backstage."}),"\n",(0,r.jsx)(t.h3,{id:"azure-app-services",children:"Azure App Services"}),"\n",(0,r.jsx)(t.p,{children:"To use EasyAuth with App Services, turn on Entra ID (formerly Azure Active Directory) authentication\nYou must also enable the token store."}),"\n",(0,r.jsx)(t.p,{children:"The following example shows how to do this via a bicep template:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bicep",children:"resource webApp 'Microsoft.Web/sites@2022-03-01' existing = {\n  name: 'MY-WEBAPP-NAME'\n\n  resource authConfig 'config' = {\n    name: 'authsettingsV2'\n    properties: {\n      globalValidation: {\n        redirectToProvider: 'AzureActiveDirectory'\n        requireAuthentication: true\n        unauthenticatedClientAction: 'RedirectToLoginPage'\n      }\n      login: {\n        tokenStore: {\n          enabled: true\n        }\n      }\n      platform: {\n        enabled: true\n      }\n      identityProviders: {\n        azureActiveDirectory: {\n          enabled: true\n          login: {\n            loginParameters: [ 'domain_hint=MYCOMPANY.COM' ]\n          }\n          registration: {\n            clientId: 'CLIENT-ID'\n            clientSecretSettingName: 'CLIENT-SECRET-NAME'\n            openIdIssuer: 'https://sts.windows.net/${tenant().tenantId}/v2.0'\n          }\n        }\n      }\n    }\n  }\n}\n"})})]})}const d=function(e={}){const{wrapper:t}=Object.assign({},(0,o.ah)(),e.components);return t?(0,r.jsx)(t,Object.assign({},e,{children:(0,r.jsx)(l,e)})):l(e)}},371426:(e,t,n)=>{var r=n(827378),o=Symbol.for("react.element"),a=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,s=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,u={key:!0,ref:!0,__self:!0,__source:!0};function c(e,t,n){var r,a={},c=null,l=null;for(r in void 0!==n&&(c=""+n),void 0!==t.key&&(c=""+t.key),void 0!==t.ref&&(l=t.ref),t)i.call(t,r)&&!u.hasOwnProperty(r)&&(a[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===a[r]&&(a[r]=t[r]);return{$$typeof:o,type:e,key:c,ref:l,props:a,_owner:s.current}}t.Fragment=a,t.jsx=c,t.jsxs=c},541535:(e,t)=>{var n=Symbol.for("react.element"),r=Symbol.for("react.portal"),o=Symbol.for("react.fragment"),a=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),s=Symbol.for("react.provider"),u=Symbol.for("react.context"),c=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),f=Symbol.for("react.lazy"),p=Symbol.iterator;var h={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},y=Object.assign,g={};function m(e,t,n){this.props=e,this.context=t,this.refs=g,this.updater=n||h}function v(){}function b(e,t,n){this.props=e,this.context=t,this.refs=g,this.updater=n||h}m.prototype.isReactComponent={},m.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},m.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},v.prototype=m.prototype;var _=b.prototype=new v;_.constructor=b,y(_,m.prototype),_.isPureReactComponent=!0;var x=Array.isArray,A=Object.prototype.hasOwnProperty,k={current:null},S={key:!0,ref:!0,__self:!0,__source:!0};function j(e,t,r){var o,a={},i=null,s=null;if(null!=t)for(o in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(i=""+t.key),t)A.call(t,o)&&!S.hasOwnProperty(o)&&(a[o]=t[o]);var u=arguments.length-2;if(1===u)a.children=r;else if(1<u){for(var c=Array(u),l=0;l<u;l++)c[l]=arguments[l+2];a.children=c}if(e&&e.defaultProps)for(o in u=e.defaultProps)void 0===a[o]&&(a[o]=u[o]);return{$$typeof:n,type:e,key:i,ref:s,props:a,_owner:k.current}}function w(e){return"object"==typeof e&&null!==e&&e.$$typeof===n}var E=/\/+/g;function P(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function C(e,t,o,a,i){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var u=!1;if(null===e)u=!0;else switch(s){case"string":case"number":u=!0;break;case"object":switch(e.$$typeof){case n:case r:u=!0}}if(u)return i=i(u=e),e=""===a?"."+P(u,0):a,x(i)?(o="",null!=e&&(o=e.replace(E,"$&/")+"/"),C(i,t,o,"",(function(e){return e}))):null!=i&&(w(i)&&(i=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(i,o+(!i.key||u&&u.key===i.key?"":(""+i.key).replace(E,"$&/")+"/")+e)),t.push(i)),1;if(u=0,a=""===a?".":a+":",x(e))for(var c=0;c<e.length;c++){var l=a+P(s=e[c],c);u+=C(s,t,o,l,i)}else if(l=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=p&&e[p]||e["@@iterator"])?e:null}(e),"function"==typeof l)for(e=l.call(e),c=0;!(s=e.next()).done;)u+=C(s=s.value,t,o,l=a+P(s,c++),i);else if("object"===s)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return u}function z(e,t,n){if(null==e)return e;var r=[],o=0;return C(e,r,"","",(function(e){return t.call(n,e,o++)})),r}function I(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var R={current:null},O={transition:null},$={ReactCurrentDispatcher:R,ReactCurrentBatchConfig:O,ReactCurrentOwner:k};t.Children={map:z,forEach:function(e,t,n){z(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return z(e,(function(){t++})),t},toArray:function(e){return z(e,(function(e){return e}))||[]},only:function(e){if(!w(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=m,t.Fragment=o,t.Profiler=i,t.PureComponent=b,t.StrictMode=a,t.Suspense=l,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=$,t.cloneElement=function(e,t,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var o=y({},e.props),a=e.key,i=e.ref,s=e._owner;if(null!=t){if(void 0!==t.ref&&(i=t.ref,s=k.current),void 0!==t.key&&(a=""+t.key),e.type&&e.type.defaultProps)var u=e.type.defaultProps;for(c in t)A.call(t,c)&&!S.hasOwnProperty(c)&&(o[c]=void 0===t[c]&&void 0!==u?u[c]:t[c])}var c=arguments.length-2;if(1===c)o.children=r;else if(1<c){u=Array(c);for(var l=0;l<c;l++)u[l]=arguments[l+2];o.children=u}return{$$typeof:n,type:e.type,key:a,ref:i,props:o,_owner:s}},t.createContext=function(e){return(e={$$typeof:u,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:s,_context:e},e.Consumer=e},t.createElement=j,t.createFactory=function(e){var t=j.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:c,render:e}},t.isValidElement=w,t.lazy=function(e){return{$$typeof:f,_payload:{_status:-1,_result:e},_init:I}},t.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=O.transition;O.transition={};try{e()}finally{O.transition=t}},t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},t.useCallback=function(e,t){return R.current.useCallback(e,t)},t.useContext=function(e){return R.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return R.current.useDeferredValue(e)},t.useEffect=function(e,t){return R.current.useEffect(e,t)},t.useId=function(){return R.current.useId()},t.useImperativeHandle=function(e,t,n){return R.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return R.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return R.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return R.current.useMemo(e,t)},t.useReducer=function(e,t,n){return R.current.useReducer(e,t,n)},t.useRef=function(e){return R.current.useRef(e)},t.useState=function(e){return R.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return R.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return R.current.useTransition()},t.version="18.2.0"},827378:(e,t,n)=>{e.exports=n(541535)},824246:(e,t,n)=>{e.exports=n(371426)},511151:(e,t,n)=>{n.d(t,{Zo:()=>s,ah:()=>a});var r=n(667294);const o=r.createContext({});function a(e){const t=r.useContext(o);return r.useMemo((()=>"function"==typeof e?e(t):{...t,...e}),[t,e])}const i={};function s({components:e,children:t,disableParentContext:n}){let s;return s=n?"function"==typeof e?e({}):e||i:a(e),r.createElement(o.Provider,{value:s},t)}}}]);