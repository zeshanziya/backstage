/*! For license information please see 87ed3cda.c3a52a44.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[652059],{586729:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var n=r(824246),o=r(511151);const i={id:"react18-migration",title:"Migrating to React 18",description:"Additional resources for the Material UI v5 migration guide specifically for Backstage"},a=void 0,s={id:"tutorials/react18-migration",title:"Migrating to React 18",description:"Additional resources for the Material UI v5 migration guide specifically for Backstage",source:"@site/../docs/tutorials/react18-migration.md",sourceDirName:"tutorials",slug:"/tutorials/react18-migration",permalink:"/docs/tutorials/react18-migration",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/tutorials/react18-migration.md",tags:[],version:"current",frontMatter:{id:"react18-migration",title:"Migrating to React 18",description:"Additional resources for the Material UI v5 migration guide specifically for Backstage"},sidebar:"docs",previous:{title:"React Router 6.0 Migration",permalink:"/docs/tutorials/react-router-stable-migration"},next:{title:"Package Role Migration",permalink:"/docs/tutorials/package-role-migration"}},c={},l=[{value:"Migration",id:"migration",level:2},{value:"Switching to React 18",id:"switching-to-react-18",level:3},{value:"TypeScript Errors",id:"typescript-errors",level:3},{value:"Migrating Tests",id:"migrating-tests",level:3},{value:"Dependency Upgrades",id:"dependency-upgrades",level:4},{value:"Test Updates",id:"test-updates",level:4}];function u(e){const t={a:"a",admonition:"admonition",br:"br",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.p,{children:"The Backstage core libraries and plugins are compatible with all versions of React from v16.8 to v18. This means that you can migrate projects at your own pace. We do however encourage you to do so sooner rather than later, both to keep up with the evolving ecosystem, but also because React 18 brings performance improvements, in particular in tests."}),"\n",(0,n.jsx)(t.h2,{id:"migration",children:"Migration"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsxs)(t.em,{children:["Before diving in, this is a heads-up that for large projects this can be a tricky migration due to the fact that it is hard to break down into a gradual migration. In practice the difficult part of this migration is switching to the new version of the ",(0,n.jsx)(t.code,{children:"@testing-library/react"})," package for tests, since there is no overlapping support across major React versions, more on that later."]})}),"\n",(0,n.jsx)(t.h3,{id:"switching-to-react-18",children:"Switching to React 18"}),"\n",(0,n.jsx)(t.p,{children:"To switch a project to React 18, there are generally three changes that need to be made."}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:["Update the resolutions in your root ",(0,n.jsx)(t.code,{children:"package.json"})," to the new versions of ",(0,n.jsx)(t.code,{children:"@types/react"})," and ",(0,n.jsx)(t.code,{children:"@types/react-dom"}),":"]}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",metastring:'title="package.json"',children:'  "resolutions": {\n    // highlight-remove-next-line\n    "@types/react": "^17",\n    // highlight-remove-next-line\n    "@types/react-dom": "^17",\n    // highlight-add-next-line\n    "@types/react": "^18",\n    // highlight-add-next-line\n    "@types/react-dom": "^18",\n  },\n'})}),"\n",(0,n.jsxs)(t.ol,{start:"2",children:["\n",(0,n.jsxs)(t.li,{children:["Update the ",(0,n.jsx)(t.code,{children:"react"})," and ",(0,n.jsx)(t.code,{children:"react-dom"})," dependencies in your ",(0,n.jsx)(t.code,{children:"packages/app/package.json"})," to the new versions:"]}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",metastring:'title="packages/app/package.json"',children:'  "dependencies": {\n    ...\n    // highlight-remove-next-line\n    "react": "^17.0.2",\n    // highlight-remove-next-line\n    "react-dom": "^17.0.2",\n    // highlight-add-next-line\n    "react": "^18.0.2",\n    // highlight-add-next-line\n    "react-dom": "^18.0.2",\n    ...\n  },\n'})}),"\n",(0,n.jsxs)(t.ol,{start:"3",children:["\n",(0,n.jsxs)(t.li,{children:["Update ",(0,n.jsx)(t.code,{children:"packages/app/src/index.tsx"})," to use the new ",(0,n.jsx)(t.code,{children:"react-dom/client"})," API to render the app:"]}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-tsx",metastring:'title="packages/app/src/index.tsx"',children:"import '@backstage/cli/asset-types';\nimport React from 'react';\n// highlight-remove-next-line\nimport ReactDOM from 'react-dom';\n// highlight-add-next-line\nimport ReactDOM from 'react-dom/client';\nimport App from './App';\n\n// highlight-remove-next-line\nReactDOM.render(<App />, document.getElementById('root'));\n// highlight-add-next-line\nReactDOM.createRoot(document.getElementById('root')!).render(<App />);\n"})}),"\n",(0,n.jsx)(t.p,{children:"Once these steps are done you should be able to run your app and see it working as before, except now using React 18."}),"\n",(0,n.jsx)(t.h3,{id:"typescript-errors",children:"TypeScript Errors"}),"\n",(0,n.jsxs)(t.p,{children:["When upgrading to React 18 you are likely to see a fair number of TypeScript type errors. A summary of the breaking changes can be found in the ",(0,n.jsx)(t.a,{href:"https://github.com/DefinitelyTyped/DefinitelyTyped/pull/56210",children:"Pull Request that introduced them"}),". A codemod is also provided to help with the migration."]}),"\n",(0,n.jsxs)(t.p,{children:["Run ",(0,n.jsx)(t.code,{children:"yarn tsc:full"})," to asses the damage."]}),"\n",(0,n.jsxs)(t.p,{children:["The good news is that these errors can be fixed while still staying on React 17. If you have a large number of errors to fix you can address as few or many is you like at a time and merge them into your main branch ",(0,n.jsx)(t.strong,{children:"without"})," the version bumps from step 1. This lets you gradually migrate the types in your project while not yet fully moving over to React 18. Once all type breakages are fixed you can move on to the next step of migrating tests."]}),"\n",(0,n.jsx)(t.h3,{id:"migrating-tests",children:"Migrating Tests"}),"\n",(0,n.jsxs)(t.p,{children:["At this point the app hopefully works and you have no type errors, but if you run your tests you may see that a lot of them are failing. This is because the current version of the ",(0,n.jsx)(t.code,{children:"@testing-library/react"})," package does not support React 18. Unfortunately the new version that we will be moving to does not support React 17, which is why we need to do this all at once."]}),"\n",(0,n.jsx)(t.admonition,{type:"info",children:(0,n.jsxs)(t.p,{children:["If migrating your entire project at once is not feasible, you can try to add ",(0,n.jsx)(t.code,{children:"devDependencies"})," for ",(0,n.jsx)(t.code,{children:"react"})," and ",(0,n.jsx)(t.code,{children:"react-dom"})," v17 to individual plugins to be migrated later. This is not something we have tried ourselves in practice, so let us know in the community Discord if you attempt this and how it goes."]})}),"\n",(0,n.jsx)(t.h4,{id:"dependency-upgrades",children:"Dependency Upgrades"}),"\n",(0,n.jsxs)(t.p,{children:["To get the tests working again we need to update ",(0,n.jsx)(t.code,{children:"@testing-library/react"})," to at least v13, although while at it is sensible to move at least all the way to v14 since the additional breaking changes have low impact. For more information on the changes in v13, see the ",(0,n.jsx)(t.a,{href:"https://github.com/testing-library/react-testing-library/releases/tag/v13.0.0",children:"release notes"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["In addition to bumping ",(0,n.jsx)(t.code,{children:"@testing-library/react"})," you also need to remove the ",(0,n.jsx)(t.code,{children:"@testing-library/react-hooks"})," package, since it is now included in ",(0,n.jsx)(t.code,{children:"@testing-library/react"})," itself. You can find more information on this change in the ",(0,n.jsx)(t.code,{children:"@testing-library/react-hooks"})," ",(0,n.jsx)(t.a,{href:"https://github.com/testing-library/react-hooks-testing-library?tab=readme-ov-file#a-note-about-react-18-support",children:"README.md"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["The following search-and-replace RegEx patterns may by helpful in updating your ",(0,n.jsx)(t.code,{children:"package.json"})," files:"]}),"\n",(0,n.jsxs)(t.p,{children:["Find: ",(0,n.jsx)(t.code,{children:'"@testing-library/react": ".*"'}),(0,n.jsx)(t.br,{}),"\nReplace: ",(0,n.jsx)(t.code,{children:'"@testing-library/react": "^14.0.0"'})]}),"\n",(0,n.jsxs)(t.p,{children:["Find: ",(0,n.jsx)(t.code,{children:'"@testing-library/react-hooks": ".*",?'}),(0,n.jsx)(t.br,{}),"\nReplace: ",(0,n.jsx)(t.code,{children:"<nothing>"})]}),"\n",(0,n.jsx)(t.h4,{id:"test-updates",children:"Test Updates"}),"\n",(0,n.jsx)(t.p,{children:"Once you have installed the new versions of the dependencies this turns into a fairly mechanical process of updating the tests. Use your own favorite method for this, running all tests once to find the breakages and then focusing on one test file at a time was fairly smooth."}),"\n",(0,n.jsx)(t.p,{children:"When updating the tests in the Backstage project we found the following patterns to be useful:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Many existing ",(0,n.jsx)(t.code,{children:"act(...)"})," calls can be removed, it is built into most testing utilities like ",(0,n.jsx)(t.code,{children:"waitFor"}),", ",(0,n.jsx)(t.code,{children:".findBy*"}),", and ",(0,n.jsx)(t.code,{children:"@testing-library/user-event"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:["Use ",(0,n.jsx)(t.code,{children:".findBy*"})," to wait for elements to appear."]}),"\n",(0,n.jsxs)(t.li,{children:["Use ",(0,n.jsx)(t.code,{children:"waitFor(...)"})," to wait for any other expected state changes or multiple elements."]}),"\n",(0,n.jsxs)(t.li,{children:["Use ",(0,n.jsx)(t.code,{children:"@testing-library/user-event"})," for user interactions."]}),"\n",(0,n.jsxs)(t.li,{children:["The ",(0,n.jsx)(t.code,{children:"renderHook"})," API has changes in several ways:\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["It no longer returns ",(0,n.jsx)(t.code,{children:"waitForValueToChange"})," or ",(0,n.jsx)(t.code,{children:"waitForNextUpdate"}),", you'll likely want to use ",(0,n.jsx)(t.code,{children:"waitFor"})," instead."]}),"\n",(0,n.jsx)(t.li,{children:"It now throws errors rather than returns them as part of the result."}),"\n",(0,n.jsxs)(t.li,{children:["It no longer forwards ",(0,n.jsx)(t.code,{children:"initialProps"})," to the ",(0,n.jsx)(t.code,{children:"wrapper"}),", a workaround for this is provided in the ",(0,n.jsx)(t.a,{href:"https://testing-library.com/docs/react-testing-library/api/#renderhook-options-initialprops",children:"docs"}),"."]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(t.li,{children:"Waiting for mock functions to be called by a component and then expecting render state to be updated is no longer reliable."}),"\n",(0,n.jsxs)(t.li,{children:["Rendered components often don't immediately update on user input, it's more common to need to use ",(0,n.jsx)(t.code,{children:"waitFor"})," or other utilities to wait for the expected state to be reached."]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["You can also refer to the test changes in this ",(0,n.jsx)(t.a,{href:"https://github.com/backstage/backstage/pull/20598/files?file-filters%5B%5D=.ts&file-filters%5B%5D=.tsx",children:"PR"}),", which was the migration to React 18 for the Backstage project itself."]}),"\n",(0,n.jsxs)(t.p,{children:["Best of luck! For question please join the ",(0,n.jsx)(t.a,{href:"https://discord.gg/backstage-687207715902193673",children:"community Discord"}),". If you think this documentation could be improved we welcome you to ",(0,n.jsx)(t.a,{href:"https://github.com/backstage/backstage/issues/new/choose",children:"open an issue"})," or submit a pull request."]})]})}function d(e={}){const{wrapper:t}={...(0,o.a)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(u,{...e})}):u(e)}},371426:(e,t,r)=>{var n=r(827378),o=Symbol.for("react.element"),i=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,s=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,r){var n,i={},l=null,u=null;for(n in void 0!==r&&(l=""+r),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(u=t.ref),t)a.call(t,n)&&!c.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===i[n]&&(i[n]=t[n]);return{$$typeof:o,type:e,key:l,ref:u,props:i,_owner:s.current}}t.Fragment=i,t.jsx=l,t.jsxs=l},541535:(e,t)=>{var r=Symbol.for("react.element"),n=Symbol.for("react.portal"),o=Symbol.for("react.fragment"),i=Symbol.for("react.strict_mode"),a=Symbol.for("react.profiler"),s=Symbol.for("react.provider"),c=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),h=Symbol.for("react.lazy"),p=Symbol.iterator;var f={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},g=Object.assign,y={};function m(e,t,r){this.props=e,this.context=t,this.refs=y,this.updater=r||f}function x(){}function j(e,t,r){this.props=e,this.context=t,this.refs=y,this.updater=r||f}m.prototype.isReactComponent={},m.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},m.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},x.prototype=m.prototype;var b=j.prototype=new x;b.constructor=j,g(b,m.prototype),b.isPureReactComponent=!0;var v=Array.isArray,w=Object.prototype.hasOwnProperty,k={current:null},_={key:!0,ref:!0,__self:!0,__source:!0};function R(e,t,n){var o,i={},a=null,s=null;if(null!=t)for(o in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(a=""+t.key),t)w.call(t,o)&&!_.hasOwnProperty(o)&&(i[o]=t[o]);var c=arguments.length-2;if(1===c)i.children=n;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];i.children=l}if(e&&e.defaultProps)for(o in c=e.defaultProps)void 0===i[o]&&(i[o]=c[o]);return{$$typeof:r,type:e,key:a,ref:s,props:i,_owner:k.current}}function S(e){return"object"==typeof e&&null!==e&&e.$$typeof===r}var E=/\/+/g;function T(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function I(e,t,o,i,a){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var c=!1;if(null===e)c=!0;else switch(s){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case r:case n:c=!0}}if(c)return a=a(c=e),e=""===i?"."+T(c,0):i,v(a)?(o="",null!=e&&(o=e.replace(E,"$&/")+"/"),I(a,t,o,"",(function(e){return e}))):null!=a&&(S(a)&&(a=function(e,t){return{$$typeof:r,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(a,o+(!a.key||c&&c.key===a.key?"":(""+a.key).replace(E,"$&/")+"/")+e)),t.push(a)),1;if(c=0,i=""===i?".":i+":",v(e))for(var l=0;l<e.length;l++){var u=i+T(s=e[l],l);c+=I(s,t,o,u,a)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=p&&e[p]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),l=0;!(s=e.next()).done;)c+=I(s=s.value,t,o,u=i+T(s,l++),a);else if("object"===s)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return c}function O(e,t,r){if(null==e)return e;var n=[],o=0;return I(e,n,"","",(function(e){return t.call(r,e,o++)})),n}function C(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var M={current:null},U={transition:null},$={ReactCurrentDispatcher:M,ReactCurrentBatchConfig:U,ReactCurrentOwner:k};t.Children={map:O,forEach:function(e,t,r){O(e,(function(){t.apply(this,arguments)}),r)},count:function(e){var t=0;return O(e,(function(){t++})),t},toArray:function(e){return O(e,(function(e){return e}))||[]},only:function(e){if(!S(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=m,t.Fragment=o,t.Profiler=a,t.PureComponent=j,t.StrictMode=i,t.Suspense=u,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=$,t.cloneElement=function(e,t,n){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var o=g({},e.props),i=e.key,a=e.ref,s=e._owner;if(null!=t){if(void 0!==t.ref&&(a=t.ref,s=k.current),void 0!==t.key&&(i=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(l in t)w.call(t,l)&&!_.hasOwnProperty(l)&&(o[l]=void 0===t[l]&&void 0!==c?c[l]:t[l])}var l=arguments.length-2;if(1===l)o.children=n;else if(1<l){c=Array(l);for(var u=0;u<l;u++)c[u]=arguments[u+2];o.children=c}return{$$typeof:r,type:e.type,key:i,ref:a,props:o,_owner:s}},t.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:s,_context:e},e.Consumer=e},t.createElement=R,t.createFactory=function(e){var t=R.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:l,render:e}},t.isValidElement=S,t.lazy=function(e){return{$$typeof:h,_payload:{_status:-1,_result:e},_init:C}},t.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=U.transition;U.transition={};try{e()}finally{U.transition=t}},t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},t.useCallback=function(e,t){return M.current.useCallback(e,t)},t.useContext=function(e){return M.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return M.current.useDeferredValue(e)},t.useEffect=function(e,t){return M.current.useEffect(e,t)},t.useId=function(){return M.current.useId()},t.useImperativeHandle=function(e,t,r){return M.current.useImperativeHandle(e,t,r)},t.useInsertionEffect=function(e,t){return M.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return M.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return M.current.useMemo(e,t)},t.useReducer=function(e,t,r){return M.current.useReducer(e,t,r)},t.useRef=function(e){return M.current.useRef(e)},t.useState=function(e){return M.current.useState(e)},t.useSyncExternalStore=function(e,t,r){return M.current.useSyncExternalStore(e,t,r)},t.useTransition=function(){return M.current.useTransition()},t.version="18.2.0"},827378:(e,t,r)=>{e.exports=r(541535)},824246:(e,t,r)=>{e.exports=r(371426)},511151:(e,t,r)=>{r.d(t,{Z:()=>s,a:()=>a});var n=r(667294);const o={},i=n.createContext(o);function a(e){const t=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);