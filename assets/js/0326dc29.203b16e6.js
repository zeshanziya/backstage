/*! For license information please see 0326dc29.203b16e6.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[662468],{828462:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>u});var r=n(824246),o=n(511151);const a={id:"gcp-iap-auth",title:"Google Identity-Aware Proxy Provider",sidebar_label:"Google IAP",description:"Adding Google Identity-Aware Proxy as an authentication provider in Backstage"},i=void 0,s={id:"auth/google/gcp-iap-auth",title:"Google Identity-Aware Proxy Provider",description:"Adding Google Identity-Aware Proxy as an authentication provider in Backstage",source:"@site/../docs/auth/google/gcp-iap-auth.md",sourceDirName:"auth/google",slug:"/auth/google/gcp-iap-auth",permalink:"/docs/auth/google/gcp-iap-auth",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/auth/google/gcp-iap-auth.md",tags:[],version:"current",frontMatter:{id:"gcp-iap-auth",title:"Google Identity-Aware Proxy Provider",sidebar_label:"Google IAP",description:"Adding Google Identity-Aware Proxy as an authentication provider in Backstage"},sidebar:"docs",previous:{title:"Google",permalink:"/docs/auth/google/provider"},next:{title:"Okta",permalink:"/docs/auth/okta/provider"}},c={},u=[{value:"Configuration",id:"configuration",level:2},{value:"Backend Changes",id:"backend-changes",level:2},{value:"Frontend Changes",id:"frontend-changes",level:2}];function l(e){const t={a:"a",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",...(0,o.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["Backstage allows offloading the responsibility of authenticating users to the\nGoogle HTTPS Load Balancer & ",(0,r.jsx)(t.a,{href:"https://cloud.google.com/iap",children:"IAP"}),", leveraging the\nauthentication support on the latter."]}),"\n",(0,r.jsx)(t.p,{children:"This tutorial shows how to use authentication on an IAP sitting in front of\nBackstage."}),"\n",(0,r.jsx)(t.p,{children:"It is assumed an IAP is already serving traffic in front of a Backstage instance\nconfigured to serve the frontend app from the backend."}),"\n",(0,r.jsx)(t.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(t.p,{children:["Let's start by adding the following ",(0,r.jsx)(t.code,{children:"auth"})," configuration in your\n",(0,r.jsx)(t.code,{children:"app-config.yaml"})," or ",(0,r.jsx)(t.code,{children:"app-config.production.yaml"})," or similar:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"auth:\n  providers:\n    gcp-iap:\n      audience: '/projects/<project number>/global/backendServices/<backend service id>'\n      jwtHeader: x-custom-header # Optional: Only if you are using a custom header for the IAP JWT\n"})}),"\n",(0,r.jsxs)(t.p,{children:["The full ",(0,r.jsx)(t.code,{children:"audience"})," value can be obtained by visiting your ",(0,r.jsx)(t.a,{href:"https://console.cloud.google.com/security/iap",children:"Identity-Aware Proxy Google Cloud console"}),', selecting your project, finding your Backend Service to proxy, clicking the 3 vertical dots then "Get JWT Audience Code", and copying from the resulting popup, which will look similar to the following:']}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Identity-Aware Proxy JWT Audience Code popup",src:n(87802).Z+"",width:"866",height:"501"})}),"\n",(0,r.jsx)(t.p,{children:"This config section must be in place for the provider to load at all. Now let's\nadd the provider itself."}),"\n",(0,r.jsx)(t.h2,{id:"backend-changes",children:"Backend Changes"}),"\n",(0,r.jsx)(t.p,{children:"This provider is not enabled by default in the auth backend code, because\nbesides the config section above, it also needs to be given one or more\ncallbacks in actual code as well as described below."}),"\n",(0,r.jsxs)(t.p,{children:["Add a ",(0,r.jsx)(t.code,{children:"providerFactories"})," entry to the router in\n",(0,r.jsx)(t.code,{children:"packages/backend/src/plugins/auth.ts"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",metastring:'title="packages/backend/src/plugins/auth.ts"',children:"import { providers } from '@backstage/plugin-auth-backend';\nimport { stringifyEntityRef } from '@backstage/catalog-model';\n\nexport default async function createPlugin(\n  env: PluginEnvironment,\n): Promise<Router> {\n  return await createRouter({\n    logger: env.logger,\n    config: env.config,\n    database: env.database,\n    discovery: env.discovery,\n    providerFactories: {\n      'gcp-iap': providers.gcpIap.create({\n        // Replace the auth handler if you want to customize the returned user\n        // profile info (can be left out; the default implementation is shown\n        // below which only returns the email). You may want to amend this code\n        // with something that loads additional user profile data out of e.g.\n        // GSuite or LDAP or similar.\n        async authHandler({ iapToken }) {\n          return { profile: { email: iapToken.email } };\n        },\n        signIn: {\n          // You need to supply an identity resolver, that takes the profile\n          // and the IAP token and produces the Backstage token with the\n          // relevant user info.\n          async resolver({ profile, result: { iapToken } }, ctx) {\n            // Somehow compute the Backstage token claims. Just some sample code\n            // shown here, but you may want to query your LDAP server, or\n            // GSuite or similar, based on the IAP token sub/email claims\n            const id = iapToken.email.split('@')[0];\n            const sub = stringifyEntityRef({ kind: 'User', name: id });\n            const ent = [\n              sub,\n              stringifyEntityRef({ kind: 'Group', name: 'team-name' }),\n            ];\n            return ctx.issueToken({ claims: { sub, ent } });\n          },\n        },\n      }),\n    },\n  });\n}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Now the backend is ready to serve auth requests on the\n",(0,r.jsx)(t.code,{children:"/api/auth/gcp-iap/refresh"})," endpoint. All that's left is to update the frontend\nsign-in mechanism to poll that endpoint through the IAP, on the user's behalf."]}),"\n",(0,r.jsx)(t.h2,{id:"frontend-changes",children:"Frontend Changes"}),"\n",(0,r.jsxs)(t.p,{children:["It is recommended to use the ",(0,r.jsx)(t.code,{children:"ProxiedSignInPage"})," for this provider, which is\ninstalled in ",(0,r.jsx)(t.code,{children:"packages/app/src/App.tsx"})," like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",metastring:'title="packages/app/src/App.tsx"',children:"/* highlight-add-next-line */\nimport { ProxiedSignInPage } from '@backstage/core-components';\n\nconst app = createApp({\n  /* highlight-add-start */\n  components: {\n    SignInPage: props => <ProxiedSignInPage {...props} provider=\"gcp-iap\" />,\n  },\n  /* highlight-add-end */\n  // ..\n});\n"})}),"\n",(0,r.jsxs)(t.p,{children:["See the ",(0,r.jsx)(t.a,{href:"/docs/auth/#sign-in-with-proxy-providers",children:"Sign-In with Proxy Providers"})," section for more information."]})]})}function d(e={}){const{wrapper:t}={...(0,o.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},87802:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/gcp-iap-jwt-audience-code-popup-af9b9676c8c8cc772a0cbeae159b0d91.png"},371426:(e,t,n)=>{var r=n(827378),o=Symbol.for("react.element"),a=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,s=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function u(e,t,n){var r,a={},u=null,l=null;for(r in void 0!==n&&(u=""+n),void 0!==t.key&&(u=""+t.key),void 0!==t.ref&&(l=t.ref),t)i.call(t,r)&&!c.hasOwnProperty(r)&&(a[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===a[r]&&(a[r]=t[r]);return{$$typeof:o,type:e,key:u,ref:l,props:a,_owner:s.current}}t.Fragment=a,t.jsx=u,t.jsxs=u},541535:(e,t)=>{var n=Symbol.for("react.element"),r=Symbol.for("react.portal"),o=Symbol.for("react.fragment"),a=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),s=Symbol.for("react.provider"),c=Symbol.for("react.context"),u=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),f=Symbol.iterator;var h={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},g=Object.assign,y={};function m(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||h}function v(){}function b(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||h}m.prototype.isReactComponent={},m.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},m.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},v.prototype=m.prototype;var k=b.prototype=new v;k.constructor=b,g(k,m.prototype),k.isPureReactComponent=!0;var x=Array.isArray,_=Object.prototype.hasOwnProperty,w={current:null},j={key:!0,ref:!0,__self:!0,__source:!0};function P(e,t,r){var o,a={},i=null,s=null;if(null!=t)for(o in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(i=""+t.key),t)_.call(t,o)&&!j.hasOwnProperty(o)&&(a[o]=t[o]);var c=arguments.length-2;if(1===c)a.children=r;else if(1<c){for(var u=Array(c),l=0;l<c;l++)u[l]=arguments[l+2];a.children=u}if(e&&e.defaultProps)for(o in c=e.defaultProps)void 0===a[o]&&(a[o]=c[o]);return{$$typeof:n,type:e,key:i,ref:s,props:a,_owner:w.current}}function S(e){return"object"==typeof e&&null!==e&&e.$$typeof===n}var I=/\/+/g;function A(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function C(e,t,o,a,i){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var c=!1;if(null===e)c=!0;else switch(s){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case n:case r:c=!0}}if(c)return i=i(c=e),e=""===a?"."+A(c,0):a,x(i)?(o="",null!=e&&(o=e.replace(I,"$&/")+"/"),C(i,t,o,"",(function(e){return e}))):null!=i&&(S(i)&&(i=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(i,o+(!i.key||c&&c.key===i.key?"":(""+i.key).replace(I,"$&/")+"/")+e)),t.push(i)),1;if(c=0,a=""===a?".":a+":",x(e))for(var u=0;u<e.length;u++){var l=a+A(s=e[u],u);c+=C(s,t,o,l,i)}else if(l=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"==typeof l)for(e=l.call(e),u=0;!(s=e.next()).done;)c+=C(s=s.value,t,o,l=a+A(s,u++),i);else if("object"===s)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return c}function E(e,t,n){if(null==e)return e;var r=[],o=0;return C(e,r,"","",(function(e){return t.call(n,e,o++)})),r}function R(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var T={current:null},$={transition:null},O={ReactCurrentDispatcher:T,ReactCurrentBatchConfig:$,ReactCurrentOwner:w};t.Children={map:E,forEach:function(e,t,n){E(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return E(e,(function(){t++})),t},toArray:function(e){return E(e,(function(e){return e}))||[]},only:function(e){if(!S(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=m,t.Fragment=o,t.Profiler=i,t.PureComponent=b,t.StrictMode=a,t.Suspense=l,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=O,t.cloneElement=function(e,t,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var o=g({},e.props),a=e.key,i=e.ref,s=e._owner;if(null!=t){if(void 0!==t.ref&&(i=t.ref,s=w.current),void 0!==t.key&&(a=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(u in t)_.call(t,u)&&!j.hasOwnProperty(u)&&(o[u]=void 0===t[u]&&void 0!==c?c[u]:t[u])}var u=arguments.length-2;if(1===u)o.children=r;else if(1<u){c=Array(u);for(var l=0;l<u;l++)c[l]=arguments[l+2];o.children=c}return{$$typeof:n,type:e.type,key:a,ref:i,props:o,_owner:s}},t.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:s,_context:e},e.Consumer=e},t.createElement=P,t.createFactory=function(e){var t=P.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:u,render:e}},t.isValidElement=S,t.lazy=function(e){return{$$typeof:p,_payload:{_status:-1,_result:e},_init:R}},t.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=$.transition;$.transition={};try{e()}finally{$.transition=t}},t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},t.useCallback=function(e,t){return T.current.useCallback(e,t)},t.useContext=function(e){return T.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return T.current.useDeferredValue(e)},t.useEffect=function(e,t){return T.current.useEffect(e,t)},t.useId=function(){return T.current.useId()},t.useImperativeHandle=function(e,t,n){return T.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return T.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return T.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return T.current.useMemo(e,t)},t.useReducer=function(e,t,n){return T.current.useReducer(e,t,n)},t.useRef=function(e){return T.current.useRef(e)},t.useState=function(e){return T.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return T.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return T.current.useTransition()},t.version="18.2.0"},827378:(e,t,n)=>{e.exports=n(541535)},824246:(e,t,n)=>{e.exports=n(371426)},511151:(e,t,n)=>{n.d(t,{Z:()=>s,a:()=>i});var r=n(667294);const o={},a=r.createContext(o);function i(e){const t=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(a.Provider,{value:t},e.children)}}}]);