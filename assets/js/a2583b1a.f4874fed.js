/*! For license information please see a2583b1a.f4874fed.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[572149],{27039:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>u});var r=n(824246),s=n(511151);const o={id:"auth",title:"Auth Service",sidebar_label:"Auth",description:"Documentation for the Auth service"},i=void 0,a={id:"backend-system/core-services/auth",title:"Auth Service",description:"Documentation for the Auth service",source:"@site/../docs/backend-system/core-services/auth.md",sourceDirName:"backend-system/core-services",slug:"/backend-system/core-services/auth",permalink:"/docs/backend-system/core-services/auth",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/backend-system/core-services/auth.md",tags:[],version:"current",frontMatter:{id:"auth",title:"Auth Service",sidebar_label:"Auth",description:"Documentation for the Auth service"},sidebar:"docs",previous:{title:"Overview",permalink:"/docs/backend-system/core-services/index"},next:{title:"Cache",permalink:"/docs/backend-system/core-services/cache"}},c={},u=[{value:"Using the Service",id:"using-the-service",level:2},{value:"Creating Request Tokens",id:"creating-request-tokens",level:3},{value:"Authorizing Tokens",id:"authorizing-tokens",level:3},{value:"Inspecting Credentials",id:"inspecting-credentials",level:3},{value:"Configuring the service",id:"configuring-the-service",level:2}];function l(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.p,{children:"This service deals with the generation and verification of tokens and their\nassociated representations as credentials objects. You can use it for validating\nincoming tokens, and generating tokens for calling other services."}),"\n",(0,r.jsxs)(t.p,{children:["If you want to deal with credentials specifically in the HTTP request/response\nflow, see also ",(0,r.jsxs)(t.a,{href:"/docs/backend-system/core-services/http-auth",children:["the ",(0,r.jsx)(t.code,{children:"httpAuth"})," service"]}),". If you want to extract\nmore details about authenticated users such as their ownership entity refs, use\n",(0,r.jsxs)(t.a,{href:"/docs/backend-system/core-services/user-info",children:["the ",(0,r.jsx)(t.code,{children:"userInfo"})," service"]}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"using-the-service",children:"Using the Service"}),"\n",(0,r.jsxs)(t.p,{children:["In the following code examples, the ",(0,r.jsx)(t.code,{children:"auth"})," and ",(0,r.jsx)(t.code,{children:"httpAuth"})," variables are assumed\nto be dependency-injected instances of the ",(0,r.jsx)(t.code,{children:"coreServices.auth"})," and\n",(0,r.jsx)(t.code,{children:"coreServices.httpAuth"})," service, respectively. For a backend plugin, it might\nlook like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"export default createBackendPlugin({\n  pluginId: 'my-plugin',\n  register(env) {\n    env.registerInit({\n      deps: {\n        auth: coreServices.auth,\n        httpAuth: coreServices.httpAuth,\n        httpRouter: coreServices.httpRouter,\n      },\n      async init({ auth, httpAuth, httpRouter }) {\n        // Your code goes here\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsx)(t.h3,{id:"creating-request-tokens",children:"Creating Request Tokens"}),"\n",(0,r.jsx)(t.p,{children:"If you need to create a token that can be used for making a request to another\nbackend plugin:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"const { token } = await auth.getPluginRequestToken({\n  onBehalfOf: await auth.getOwnServiceCredentials(),\n  targetPluginId: 'catalog',\n});\n"})}),"\n",(0,r.jsx)(t.admonition,{title:"Note",type:"note",children:(0,r.jsxs)(t.p,{children:["Never store and reuse tokens. Always call ",(0,r.jsx)(t.code,{children:"getPluginRequestToken"})," immediately\nbefore making a request. Otherwise you run the risk of running into permission\nproblems when expired tokens are being used for requests."]})}),"\n",(0,r.jsx)(t.p,{children:'This example is suitable when you need to make the request "as your own plugin",\ni.e. when your code is the original initiator of the call. An example of this\ncould be periodic batch processes that index content in another service.'}),"\n",(0,r.jsx)(t.p,{children:"In situations where you are making a call on-behalf-of someone else, for example\nwhen making upstream requests inside a request handler, please always instead\nuse the extracted credentials from the request."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"router.get('/makes-calls', async (req, res) => {\n  const { token } = await auth.getPluginRequestToken({\n    onBehalfOf: await httpAuth.credentials(req),\n    targetPluginId: 'catalog',\n  });\n  // make a call using the token\n"})}),"\n",(0,r.jsxs)(t.p,{children:["This ensures that the original caller and their associated permissions are\nproperly carried along with the request chain. See ",(0,r.jsxs)(t.a,{href:"/docs/backend-system/core-services/http-auth",children:["the ",(0,r.jsx)(t.code,{children:"httpAuth"})," service docs"]}),"\nfor more details."]}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.a,{href:"/docs/auth/service-to-service-auth",children:"service to service auth docs"}),"\ncontain more details about how to properly use tokens in your HTTP request\npaths."]}),"\n",(0,r.jsx)(t.h3,{id:"authorizing-tokens",children:"Authorizing Tokens"}),"\n",(0,r.jsxs)(t.p,{children:["Most plugins should not deal with incoming request tokens directly at all, but\nrather use ",(0,r.jsx)(t.a,{href:"/docs/backend-system/core-services/http-auth",children:(0,r.jsx)(t.code,{children:"httpAuth.credentials"})})," instead as part of their\nrequest handlers. But in the rare cases where you are holding an incoming token\nand want to validate it and turn it into a credentials object, you can do so:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"const credentials = await auth.authenticate(token);\n"})}),"\n",(0,r.jsxs)(t.p,{children:["There is an optional second parameter that you can set to ",(0,r.jsx)(t.code,{children:"{ allowLimitedAccess: true }"})," if you specifically built a plugin that deals with cookie based access,\nwhich is rare."]}),"\n",(0,r.jsx)(t.h3,{id:"inspecting-credentials",children:"Inspecting Credentials"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"auth"})," service also contains facilities for working with credentials\nobjects. For example checking what type of principal (caller type - e.g. user or\nservice) they represent. For example:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"if (auth.isPrincipal(credentials, 'user)) {\n  // In here, the TypeScript type of the credentials object has been properly\n  // narrowed to `BackstageCredentials<BackstageUserPrincipal>` so you can\n  // access its specific properties such as `credentials.principal.userEntityRef`.\n}\n"})}),"\n",(0,r.jsx)(t.h2,{id:"configuring-the-service",children:"Configuring the service"}),"\n",(0,r.jsx)(t.admonition,{title:"Note",type:"note",children:(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"auth"})," service is not suitable for having its implementation replaced\nentirely in your private repo. If you desire additional service auth related\nfeatures, don't hesitate to ",(0,r.jsx)(t.a,{href:"https://github.com/backstage/backstage/issues/new/choose",children:"file an issue"}),"\nor ",(0,r.jsx)(t.a,{href:"https://github.com/backstage/backstage/blob/master/CONTRIBUTING.md",children:"contribute"})," to the open source features."]})}),"\n",(0,r.jsxs)(t.p,{children:["For configuring service-to-service access methods, see ",(0,r.jsx)(t.a,{href:"/docs/auth/service-to-service-auth",children:"the auth docs"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["The default auth policy requires all requests to be authenticated with either\nuser or service credentials. This can be disabled by setting the\n",(0,r.jsx)(t.code,{children:"backend.auth.dangerouslyDisableDefaultAuthPolicy"})," app-config flag to ",(0,r.jsx)(t.code,{children:"true"}),".\nDisabling this check means that the backend will no longer block unauthenticated\nrequests, but instead allow them to pass through to plugins. Do not do this in\nproduction unless absolutely necessary."]}),"\n",(0,r.jsx)(t.p,{children:"If permissions are enabled, unauthenticated requests will be treated exactly as\nsuch, leaving it to the permission policy to determine what permissions should\nbe allowed for an unauthenticated identity. Note that this will also apply to\nservice-to-service calls between plugins unless you configure credentials for\nservice calls."})]})}function h(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},371426:(e,t,n)=>{var r=n(827378),s=Symbol.for("react.element"),o=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,a=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function u(e,t,n){var r,o={},u=null,l=null;for(r in void 0!==n&&(u=""+n),void 0!==t.key&&(u=""+t.key),void 0!==t.ref&&(l=t.ref),t)i.call(t,r)&&!c.hasOwnProperty(r)&&(o[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===o[r]&&(o[r]=t[r]);return{$$typeof:s,type:e,key:u,ref:l,props:o,_owner:a.current}}t.Fragment=o,t.jsx=u,t.jsxs=u},541535:(e,t)=>{var n=Symbol.for("react.element"),r=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),c=Symbol.for("react.context"),u=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),h=Symbol.for("react.memo"),d=Symbol.for("react.lazy"),f=Symbol.iterator;var p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},y=Object.assign,m={};function v(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||p}function g(){}function b(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||p}v.prototype.isReactComponent={},v.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},v.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},g.prototype=v.prototype;var k=b.prototype=new g;k.constructor=b,y(k,v.prototype),k.isPureReactComponent=!0;var x=Array.isArray,j=Object.prototype.hasOwnProperty,w={current:null},_={key:!0,ref:!0,__self:!0,__source:!0};function S(e,t,r){var s,o={},i=null,a=null;if(null!=t)for(s in void 0!==t.ref&&(a=t.ref),void 0!==t.key&&(i=""+t.key),t)j.call(t,s)&&!_.hasOwnProperty(s)&&(o[s]=t[s]);var c=arguments.length-2;if(1===c)o.children=r;else if(1<c){for(var u=Array(c),l=0;l<c;l++)u[l]=arguments[l+2];o.children=u}if(e&&e.defaultProps)for(s in c=e.defaultProps)void 0===o[s]&&(o[s]=c[s]);return{$$typeof:n,type:e,key:i,ref:a,props:o,_owner:w.current}}function R(e){return"object"==typeof e&&null!==e&&e.$$typeof===n}var C=/\/+/g;function T(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function E(e,t,s,o,i){var a=typeof e;"undefined"!==a&&"boolean"!==a||(e=null);var c=!1;if(null===e)c=!0;else switch(a){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case n:case r:c=!0}}if(c)return i=i(c=e),e=""===o?"."+T(c,0):o,x(i)?(s="",null!=e&&(s=e.replace(C,"$&/")+"/"),E(i,t,s,"",(function(e){return e}))):null!=i&&(R(i)&&(i=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(i,s+(!i.key||c&&c.key===i.key?"":(""+i.key).replace(C,"$&/")+"/")+e)),t.push(i)),1;if(c=0,o=""===o?".":o+":",x(e))for(var u=0;u<e.length;u++){var l=o+T(a=e[u],u);c+=E(a,t,s,l,i)}else if(l=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"==typeof l)for(e=l.call(e),u=0;!(a=e.next()).done;)c+=E(a=a.value,t,s,l=o+T(a,u++),i);else if("object"===a)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return c}function q(e,t,n){if(null==e)return e;var r=[],s=0;return E(e,r,"","",(function(e){return t.call(n,e,s++)})),r}function A(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var I={current:null},P={transition:null},O={ReactCurrentDispatcher:I,ReactCurrentBatchConfig:P,ReactCurrentOwner:w};t.Children={map:q,forEach:function(e,t,n){q(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return q(e,(function(){t++})),t},toArray:function(e){return q(e,(function(e){return e}))||[]},only:function(e){if(!R(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=v,t.Fragment=s,t.Profiler=i,t.PureComponent=b,t.StrictMode=o,t.Suspense=l,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=O,t.cloneElement=function(e,t,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var s=y({},e.props),o=e.key,i=e.ref,a=e._owner;if(null!=t){if(void 0!==t.ref&&(i=t.ref,a=w.current),void 0!==t.key&&(o=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(u in t)j.call(t,u)&&!_.hasOwnProperty(u)&&(s[u]=void 0===t[u]&&void 0!==c?c[u]:t[u])}var u=arguments.length-2;if(1===u)s.children=r;else if(1<u){c=Array(u);for(var l=0;l<u;l++)c[l]=arguments[l+2];s.children=c}return{$$typeof:n,type:e.type,key:o,ref:i,props:s,_owner:a}},t.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},t.createElement=S,t.createFactory=function(e){var t=S.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:u,render:e}},t.isValidElement=R,t.lazy=function(e){return{$$typeof:d,_payload:{_status:-1,_result:e},_init:A}},t.memo=function(e,t){return{$$typeof:h,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=P.transition;P.transition={};try{e()}finally{P.transition=t}},t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},t.useCallback=function(e,t){return I.current.useCallback(e,t)},t.useContext=function(e){return I.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return I.current.useDeferredValue(e)},t.useEffect=function(e,t){return I.current.useEffect(e,t)},t.useId=function(){return I.current.useId()},t.useImperativeHandle=function(e,t,n){return I.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return I.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return I.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return I.current.useMemo(e,t)},t.useReducer=function(e,t,n){return I.current.useReducer(e,t,n)},t.useRef=function(e){return I.current.useRef(e)},t.useState=function(e){return I.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return I.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return I.current.useTransition()},t.version="18.2.0"},827378:(e,t,n)=>{e.exports=n(541535)},824246:(e,t,n)=>{e.exports=n(371426)},511151:(e,t,n)=>{n.d(t,{Z:()=>a,a:()=>i});var r=n(667294);const s={},o=r.createContext(s);function i(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);